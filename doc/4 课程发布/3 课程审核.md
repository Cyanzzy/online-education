# 需求分析

## 业务流程

根据模块需求分析，课程发布前要先审核，审核通过方可发布。下图是课程审核及发布的流程图  

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-103.png)

> 课程审核通过才发布 

防止课程信息有违规情况，课程信息不完善对网站用户体验也不好，课程审核不仅起到监督作用，也是帮助教学机构规范使用平台的手段。

> 如何控制课程审核通过才可以发布课程 

在课程基本表course_base表设置课程审核状态字段，包括：未提交、已提交(未审核)、审核通过、审核不通过。

> 课程状态的转化关系

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-104.png)

1. 一门课程新增后它的审核状为”未提交“，发布状态为”未发布“。

2. 课程信息编辑完成，教学机构人员执行”提交审核“操作。此时课程的审核状态为”已提交“。

3. 当课程状态为已提交时运营平台人员对课程进行审核。

4. 运营平台人员审核课程，结果有两个：审核通过、审核不通过。

5. 课程审核过后不管状态是通过还是不通过，教学机构可以再次修改课程并提交审核，此时课程状态为”已提交“。此时运营平台人员再次审核课程。

6. 课程审核通过，教学机构人员可以发布课程，发布成功后课程的发布状态为”已发布“。

7. 课程发布后通过”下架“操作可以更改课程发布状态为”下架“

8. 课程下架后通过”上架“操作可以再次发布课程，上架后课程发布状态为“发布”。

## 数据模型

> 课程提交审核后还允许修改课程吗？

如果不允许修改是不合理的，因为提交审核后可以继续做下一个阶段的课程内容，比如添加课程计划，上传课程视频等。

> 如果允许修改那么课程审核时看到的课程内容从哪里来？如果也从课程基本信息表、课程营销表、课程计划表查询那么存在什么问题呢？

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-105.png)

运营人员审核课程和教学机构编辑课程操作的数据是同一份，此时会导致冲突。比如：运营人员正在审核时教学机构把数据修改了。

为了解决这个问题，专门设计课程预发布表。

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-106.png)

提交课程审核，将课程信息汇总后写入课程预发布表，课程预发布表记录了教学机构在某个时间点要发布的课程信息。

课程审核人员从预发布表查询信息进行审核。

课程审核的同时可以对课程进行修改，修改的内容不会写入课程预发布表。

课程审核通过执行课程发布，将课程预发布表的信息写入课程发布表。

> 提交审核课程后，也修改了课程信息，可以再次提交审核吗  

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-107.png)

提交审核课程后，必须等到课程审核完成才可以再次提交课程。课程审核功能涉及教学机构提交审核，运营人员进行课程审核。

提交审核将信息写入课程预发布表，课程预发布表结构如下  

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-108.png)

更新课程基本信息表的课程审核状态为：已经提交

课程审核后更新课程基本信息表的审核状态、课程预发布表的审核状态，并将审核结果写入课程审核记录。

审核记录表结构如下

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-109.png)

# 接口定义

定义提交课程审核的接口，在课程发布Controller中定义接口如下  

```java
@ResponseBody
@PostMapping("/courseaudit/commit/{courseId}")
public void commitAudit(@PathVariable("courseId") Long courseId) {

}
```

# 接口开发

## DAO

1、查询课程基本信息、课程营销信息、课程计划信息等课程相关信息，整合为课程预发布信息。

2、向课程预发布表course_publish_pre插入一条记录，如果已经存在则更新，审核状态为：已提交。

3、更新课程基本表course_base课程审核状态为：已提交。

约束：

1、对已提交审核的课程不允许提交审核。

2、本机构只允许提交本机构的课程。

3、没有上传图片不允许提交审核。

4、没有添加课程计划不允许提交审核。

## Service

```java

/**
 * 提交审核
 *
 * @param courseId  课程id
 */
void commitAudit(Long companyId,Long courseId);
```

```java
@Transactional
public void commitAudit(Long companyId, Long courseId) {

    CourseBaseInfoDto courseBaseInfo = courseBaseInfoService.getCourseBaseInfo(courseId);
    if (courseBaseInfo == null) {
        BusinessException.cast("课程未找到");
    }

    // 审核状态
    String auditStatus = courseBaseInfo.getAuditStatus();
    // 约束1 如果课程的审核状态未已条件则不允许提交
    if (auditStatus.equals("202003")) {
        BusinessException.cast("课程已提交，请等待审核");
    }
    // 约束2 课程图片没有则不允许提交
    String pic = courseBaseInfo.getPic();
    if (StringUtils.isEmpty(pic)) {
        BusinessException.cast("请上传图片");
    }
    // 约束3 课程计划没有则不允许提交
    List<TeachplanDto> teachplanTree = teachplanService.findTeachplanTree(courseId);
    if (teachplanTree == null || teachplanTree.size() == 0) {
        BusinessException.cast("请填写课程计划");
    }
    // 约束4 本机构只能提交本机构的课程
    if (!courseBaseInfo.getCompanyId().equals(companyId)) {
        BusinessException.cast("不允许提交其他机构的课程");
    }
    // 将课程基本信息、课程营销信息、课程计划信息插入课程发布表
    CoursePublishPre coursePublishPre = new CoursePublishPre();
    BeanUtils.copyProperties(courseBaseInfo, coursePublishPre);

    // 设置机构id
    coursePublishPre.setCompanyId(companyId);

    // 课程营销信息
    CourseMarket courseMarket = courseMarketMapper.selectById(courseId);
    // 课程营销信息Java对象--> Json格式
    String courseMarketJson = JSON.toJSONString(courseMarket);
    coursePublishPre.setMarket(courseMarketJson);

    // 课程计划信息
    String teachplanTreeJson = JSON.toJSONString(teachplanTree);
    coursePublishPre.setTeachplan(teachplanTreeJson);

    // 预发布状态-->已提交
    coursePublishPre.setStatus("202003");

    // 提交时间
    coursePublishPre.setCreateDate(LocalDateTime.now());

    // 查询课程发布表，如果有记录则执行更新，没有则插入
    CoursePublishPre coursePublishPreObj = coursePublishPreMapper.selectById(courseId);
    if (coursePublishPreObj == null) {
        // 执行插入
        coursePublishPreMapper.insert(coursePublishPre);
    } else {
        // 执行更新
        coursePublishPreMapper.updateById(coursePublishPre);
    }

    // 更新课程基本信息表的审核状态为已提交
    CourseBase courseBase = courseBaseMapper.selectById(courseId);
    courseBase.setAuditStatus("202003"); // 审核状态 已提交

    courseBaseMapper.updateById(courseBase);
}
```



在课堂上我们仅实现教学机构提交审核功能，**课程审核的结果通过手动修改数据库来实现**。

虽然课堂上不实现课程审核功能，完整的课程审核数据表设计需要理解。