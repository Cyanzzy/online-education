# 需求分析

课程预览就是把课程的相关信息进行整合，在课程详情界面进行展示，通过课程预览页面查看信息是否存在问题  

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-93.png)

> 课程预览的数据来源  

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-94.png)

在课程预览页面点击"视频播放图片"打开视频播放页面，通过视频播放页面查看课程计划对应的视频是否存在问题  

课程预览的效果与最终课程发布后查看到的效果是一致的，所以课程预览时会通过网站门户域名地址进行预览，下图显示了整个课程预览的流程图：

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-95.png)

1、点击课程预览，通过Nginx、后台服务网关请求内容管理服务进行课程预览。

2、内容管理服务查询课程相关信息进行整合，并通过模板引擎技术在服务端渲染生成页面，返回给浏览器。

3、通过课程预览页面点击”马上学习“打开视频播放页面。

4、视频播放页面通过Nginx请求后台服务网关，查询课程信息展示课程计划目录，请求媒资服务查询课程计划绑定的视频文件地址，在线浏览播

放视频。

#  模板引擎

早期我们采用的jsp技术就是一种模板引擎技术，如下图：

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-96.png)

1、浏览器请求web服务器

2、服务器渲染页面，渲染的过程就是向jsp页面(模板)内填充数据(模型)。

3、服务器将渲染生成的页面返回给浏览器。

所以模板引擎就是：模板+数据=输出，Jsp页面就是模板，页面中嵌入的jsp标签就是数据，两者相结合输出html网页。

本项目采用Freemarker作为模板引擎技术。 FreeMarker 是一款 模板引擎： 即一种基于模板和要改变的数据， 并用来生成输出文本(HTML网页，电子邮件，配置文件，源代码等)的通用工具。 它不是面向最终用户的，而是一个Java类库，是一款程序员可以嵌入他们所开发产品的组件  

Freemarker官方地址：http://freemarker.foofun.cn/

> 快速入门

在内容管理接口层搭建Freemarker的运行环境并进行测试，在内容管理接口工层 添加Freemarker与SpringBoot的整合包

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-freemarker</artifactId>
</dependency>
```

在nacos为内容管理接口层配置freemarker，公用配置组新加一个freemarker-config-dev.yaml 

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-97.png)

在内容管理接口工程添加freemarker-config-dev.yaml

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-98.png)

添加模板，在resources下创建templates目录，添加test.ftl模板文件

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello World!</title>
</head>
<body>
Hello ${name}!
</body>
</html>
```

> freemarker测试

```java
@Controller
public class FreemarkerController {

    @GetMapping("/testfreemarker")
    public ModelAndView test(){
        ModelAndView modelAndView = new ModelAndView();
        //设置模型数据
        modelAndView.addObject("name","小明");
        //设置模板名称
        modelAndView.setViewName("test");
        return modelAndView;
    }

}
```

启动内容管理接口工程，访问http://localhost:63040/content/testfreemarker

# 静态页面测试

## 部署网站门户

在课程预览界面上要加载css、js、图片等内容，这里部署nginx来访问这些静态资源，对于SpringBoot服务的动态资源由Nginx去代理请求  

> 部署前端工程

1. 准备`online-education-ui-pc-static-portal`
2. 修改本机hosts文件 ，加入127.0.0.1 www.51xuecheng.cn 51xuecheng.cn ucenter.51xuecheng.cn teacher.51xuecheng.cn file.51xuecheng.cn  

window10操作系统hosts文件在C:\Windows\System32\drivers\etc下

Centos7操作系统的文件在目录下

```text
    server {
        listen       80;
        server_name  www.51xuecheng.cn localhost;
        #rewrite ^(.*) https://$server_name$1 permanent;
        #charset koi8-r;
        ssi on;
        ssi_silent_errors on;
        #access_log  logs/host.access.log  main;

        location / {
            alias  F:/GitSpace/online-education/online-education-ui-pc-static-portal/;
            index  index.html index.htm;
        }
        #静态资源
        location /static/img/ {  
                alias F:/GitSpace/online-education/online-education-ui-pc-static-portal/img/;
        } 
        location /static/css/ {  
                alias  F:/GitSpace/online-education/online-education-ui-pc-static-portal/css/;
        } 
        location /static/js/ {  
                alias  F:/GitSpace/online-education/online-education-ui-pc-static-portal/js/;
        } 
        location /static/plugins/ {  
                alias  F:/GitSpace/online-education/online-education-ui-pc-static-portal/plugins/;
                add_header Access-Control-Allow-Origin http://ucenter.51xuecheng.cn;  
                add_header Access-Control-Allow-Credentials true;  
                add_header Access-Control-Allow-Methods GET;
        } 
        location /plugins/ {  
                alias  F:/GitSpace/online-education/online-education-ui-pc-static-portal/plugins/;
        } 



        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        # proxy the PHP scripts to Apache listening on 127.0.0.1:80
        #
        #location ~ \.php$ {
        #    proxy_pass   http://127.0.0.1;
        #}

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ \.php$ {
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #    deny  all;
        #}
    }
```

启动nginx成功访问http://www.51xuecheng.cn 

## 课程详情页面

通过浏览器访问：http://www.51xuecheng.cn/course/course_template.html 

## 文件服务器

在进行课程预览时需要展示课程的图片，在线插放课程视频，课程图片、视频这些都在MinIO文件系统存储，下边统一由Nginx代理，通过文件服务域名统一访问  

在hosts文件配置如下内容，如果已存在不要重复配置。

```
127.0.0.1 www.51xuecheng.cn file.51xuecheng.cn
```

在nginx.conf中配置文件服务器的代理地址

```text
 #文件服务
  upstream fileserver{
    server 127.0.0.1:9000 weight=10;
  } 
   server {
        listen       80;
        server_name  file.51xuecheng.cn;
        #charset koi8-r;
        ssi on;
        ssi_silent_errors on;
        #access_log  logs/host.access.log  main;
        location /video {
            proxy_pass   http://fileserver;
        }

        location /mediafiles {
            proxy_pass   http://fileserver;
        }
   }

```

配置完毕，重新加载nginx配置文件。

通过cmd进入nginx.exe所在目录,运行如下命令

```bash
nginx.exe -s reload  
```

通过http://file.51xuecheng.cn/mediafiles/图片文件地址 访问图片，如

http://file.51xuecheng.cn/mediafiles/2023/06/16/2dc98846b02dbdbed371514e2aaf8a0c.jpg 

## 视频播放页面

进入课程详情页面，点击马上学习或课程目录下的小节的名称将打开视频播放页面 ，在nginx.conf中配置视频播放页面的地址

```text
location /course/preview/learning.html {
        alias F:/GitSpace/online-education/online-education-ui-pc-static-portal/course/learning.html;
} 
location /course/search.html {  
        root   F:/GitSpace/online-education/online-education-ui-pc-static-portal;
} 
location /course/learning.html {  
        root   F:/GitSpace/online-education/online-education-ui-pc-static-portal;
} 
```

加载nginx配置文件，点击课程详情页面上的视频播放链接，打开视频播放页面

下边需要配置learning.html页面的视频播放路径来测试视频播放页面，找到learning.html页面中videoObject对象的定义处，配置视频的播放地址  

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-99.png)

配置完成，刷新页面，观察视频是否可以正常播放。

注意：此页面会去请求后台接口获取课程计划，这里暂时不处理，稍后在接口开发处进行处理。只要页面可以正常打开，可以播放视频就测试通过了。

# 接口定义

## 定义课程预览接口

课程预览接口要将课程信息进行整合，在服务端渲染页面后返回浏览器。

对课程预览接口进行分析：

1、请求参数

传入课程id，表示要预览哪一门课程。

2、响应结果

输出课程详情页面到浏览器

响应页面到浏览器使用freemarker模板引擎技术实现，参见内容管理的接口工程的resources/templates下的course_template.ftl

然后定义控制层接口

```java
@Controller
public class CoursePublishController {


    @GetMapping("/coursepreview/{courseId}")
    public ModelAndView preview(@PathVariable("courseId") Long courseId) {

        ModelAndView modelAndView = new ModelAndView();
        modelAndView.addObject("model",null);
        modelAndView.setViewName("course_template");
        return modelAndView;
    }

}
```

重启内容管理接口工程，访问http://localhost:63040/content/coursepreview/74 

结果：页面正常显示，但样式没有渲染

## 配置反向代理

课程预览接口虽然可以正常访问，但是页面没有样式，查看浏览器请求记录，发现图片、样式无法正常访问  

这些静态资源全在门户下，我们需要由Nginx反向代理访问课程预览接口，通过门户的URL去访问课程预览。

1.在Nginx下配置  

```txt
  #后台网关
  upstream gatewayserver{
    server 127.0.0.1:63010 weight=10;
  } 
  server {
        listen       80;
        server_name  www.51xuecheng.cn localhost;
        ....
        #api
        location /api/ {
                proxy_pass http://gatewayserver/;
        } 
        ....
```

2.重新加载Nginx配置文件  

```bash
nginx.exe -s reload
```

3.启动微服务网关

4.此时访问新地址： http://www.51xuecheng.cn/api/content/coursepreview/74   

页面虽然正常，但是里边的内容都是静态内容，稍后接口层调用service方式获取模型数据并进行页面渲染。

目前的方式是通过Nginx访问网关，由网关再将请求转发到微服务，Nginx是整个的项目最前方的代理服务器，如下图  

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-100.png)

# 接口开发

## 数据模型

课程预览就是把课程基本信息、营销信息、课程计划、师资等课程的相关信息进行整合，在预览页面进行展示 ，在使用freemarker渲染生成视图时需要数据模型，此数据模型包括了基本信息、营销信息、课程计划、师资等信息。

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-94.png))

> 定义数据模型类

```java
@Data
 @ToString
public class CoursePreviewDto {

    //课程基本信息,课程营销信息
    CourseBaseInfoDto courseBase;

    //课程计划信息
    List<TeachplanDto> teachplans;
    
    //师资信息暂时不加...
}

```

CourseBaseInfoDto：包括了课程基本信息、营销信息。

List<TeachplanDto> ：包括了课程计划列表。

## Service

Service负责从数据库查询基本信息、营销信息、课程计划等课程相关信息，组成CoursePreviewDto 对象。

```java
public interface CoursePublishService {

    /**
     * 获取课程预览信息
     *
     * @param courseId 课程id
     */
    CoursePreviewDto getCoursePreviewInfo(Long courseId);

}
```

```java
@Service
public class CoursePublishServiceImpl implements CoursePublishService {

    @Resource
    private CourseBaseInfoService courseBaseInfoService;

    @Resource
    private TeachplanService teachplanService;


    @Override
    public CoursePreviewDto getCoursePreviewInfo(Long courseId) {

        CoursePreviewDto coursePreviewDto = new CoursePreviewDto();

        // 课程基本信息 课程营销信息
        CourseBaseInfoDto courseBaseInfo = courseBaseInfoService.getCourseBaseInfo(courseId);
        coursePreviewDto.setCourseBase(courseBaseInfo);

        // 课程计划信息
        List<TeachplanDto> teachplanTree = teachplanService.findTeachplanTree(courseId);
        coursePreviewDto.setTeachplans(teachplanTree);

        return coursePreviewDto;
    }
}
```

## 接口层

```java
@Controller
public class CoursePublishController {

    @Resource
    private CoursePublishService coursePublishService;

    @GetMapping("/coursepreview/{courseId}")
    public ModelAndView preview(@PathVariable("courseId") Long courseId) {

        // 获取课程预览信息
        CoursePreviewDto coursePreviewInfo = coursePublishService.getCoursePreviewInfo(courseId);

        ModelAndView modelAndView = new ModelAndView();
        // 指定模型
        modelAndView.addObject("model",coursePreviewInfo);
        // 指定模板
        modelAndView.setViewName("course_template");
        return modelAndView;
    }

}
```

## 前后端联调

原来前端直接指向后台网关地址，现在要更改为Nginx的地址，如下  

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-101.png)

重启前端工程，进入课程列表点击"预览"按钮，正常打开课程预览页面http://www.51xuecheng.cn/api/content/coursepreview/2

## 编写模板

模型数据准备好后下一步将模型数据填充到course_template.ftl上，填充时注意不要一次填充太多，一边填充一边刷新调试。  

[Freemarker参考指令](http://freemarker.foofun.cn/ref_directives.html )

## 视频播放页面接口

从课程详情页面进入视频播放页面，如下图：

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-102.png)

在此页面需要从后台获取课程信息、根据课程计划获取对应的视频地址，下边编写这两个接口：

> 获取课程信口

```json
/open/content/course/whole/课程id

响应：同课程预览service接口返回数据
```

> 根据课程计划获取视频地址接口  

```json
/open/media/preview/课程计划id

响应：
{"code":0,"msg":"success","result":"视频的url","successful":true}
```

> 步骤

1.在nginx配置如下地址  

```text
#openapi
location /open/content/ {
        proxy_pass http://gatewayserver/content/open/;
} 
location /open/media/ {
        proxy_pass http://gatewayserver/media/open/;
} 
```

配置运行nginx.exe -s reload加载nginx的配置文件 

2.在内容管理接口层定义CourseOpenController类，并定义接口：获取课程信息接口：/open/content/course/whole/{courseId}

```java
@Api(value = "课程公开查询接口", tags = "课程公开查询接口")
@RestController
@RequestMapping("/open")
public class CourseOpenController {

    @Resource
    private CourseBaseInfoService courseBaseInfoService;

    @Resource
    private CoursePublishService coursePublishService;


    @GetMapping("/course/whole/{courseId}")
    public CoursePreviewDto getPreviewInfo(@PathVariable("courseId") Long courseId) {

        // 获取课程预览信息
        return coursePublishService.getCoursePreviewInfo(courseId);
    }
    
}
```

3.在媒资管理服务media-api工程定义MediaOpenController类，并定义接口/open/media/preview/

```java
@Api(value = "媒资文件管理接口", tags = "媒资文件管理接口")
@RestController
@RequestMapping("/open")
public class MediaOpenController {

    @Resource
    private MediaFileService mediaFileService;

    @ApiOperation("预览文件")
    @GetMapping("/preview/{mediaId}")
    public RestResponse<String> getPlayUrlByMediaId(@PathVariable String mediaId){

        MediaFiles mediaFiles = mediaFileService.getFileById(mediaId);
        if(mediaFiles == null || StringUtils.isEmpty(mediaFiles.getUrl())){
            BusinessException.cast("视频还没有转码处理");
        }
        return RestResponse.success(mediaFiles.getUrl());
    }
    
}
```

4.测试

定义好后，启动内容管理、媒资管理、后台服务网关服务，测试视频播放页面是否可以正常获取课程计划，点击具体的课程计划是否正常可以播放视频。