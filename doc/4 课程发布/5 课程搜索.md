# 需求分析

## 模块介绍

搜索功能是一个系统的重要功能，是信息查询的方式。课程搜索是课程展示的渠道，用户通过课程搜索找到课程信息，进一步去查看课程的详细信息，进行选课、支付、学习。

> 本项目的课程搜索支持全文检索技术

全文检索是指计算机索引程序通过扫描文章中的每一个词，对每一个词建立一个索引，指明该词在文章中出现的次数和位置，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户的检索方式。这个过程类似于通过字典中的检索字表查字的过程。

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-127.png)        课程搜索也要将课程信息建立索引，在课程发布时建立课程索引，索引建立好用户可通过搜索网页去查询课程信息  

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-128.png)

所以，课程搜索模块包括两部分：课程索引、课程搜索。

课程索引是将课程信息建立索引。

课程搜索是通过前端网页，通过关键字等条件去搜索课程。

## 业务流程

根据模块介绍的内容，课程搜索模块包括课程索引、课程搜索两部分。

1、课程索引

在课程发布操作执行后通过消息处理方式创建课程索引，如下图：

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-118.png)

本项目使用elasticsearch作为索引及搜索服务。

2、课程搜索

课程索引创建完成，用户才可以通过前端搜索课程信息。

课程搜索可以从首页进入搜索页面。

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-129.png)

下图是搜索界面，可以通过课程分类、课程难度等级等条件进行搜索。

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-130.png)

# 准备环境

## 搭建elasticsearch

 拉取daocker镜像，这里采用的是ElasticSearch的7.12.1版本镜像 

```shell
docker pull elasticsearch:7.12.1
```

运行docker命令，部署单点ES

```shell
docker run -d \
    --name es \
    -e "ES_JAVA_OPTS=-Xms512m -Xmx512m" \
    -e "discovery.type=single-node" \
    -v es-data:/usr/share/elasticsearch/data \
    -v es-plugins:/usr/share/elasticsearch/plugins \
    --privileged \
    --network es-net \
    -p 9200:9200 \
    elasticsearch:7.12.1
```

 成功启动后，访问http://192.168.101.128:9200/ 可以看到ElasticSearch的响应结果 

 拉取kibana的docker镜像，注意版本需与ElasticSearch的版本一致 

```shell
docker pull kibana:7.12.1
```

 运行docker命令，部署kibana 

```shell
docker run -d \
    --name kibana \
    -e ELASTICSEARCH_HOSTS=http://es:9200 \
    --network=es-net \
    -p 5601:5601 \
    kibana:7.12.1
```

成功启动后，访问http://192.168.101.128:5601/ 可以看到kibana的初始页面

 由于ElasticSearch的默认分词对中文的支持不太好，所以这里我们需要安装IK分词器 

```shell
# 进入容器内部
docker exec -it elasticsearch /bin/bash

# 在线下载并安装
./bin/elasticsearch-plugin  install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.12.1/elasticsearch-analysis-ik-7.12.1.zip

#退出
exit
#重启容器
docker restart elasticsearch
```

## 创建索引

 创建course_publish，即课程发布表的索引，表结构如下 

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-131.png)

 根据表中的字段创建索引，其中market、teachplan、teachers、onlineDate、offlineDate没有创建 

PUT /course-publish

```json
{
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 0
  },
  "mappings": {
    "properties": {
      "id": {
        "type": "keyword"
      },
      "companyId": {
        "type": "keyword"
      },
      "companyName": {
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart",
        "type": "text"
      },
      "name": {
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart",
        "type": "text"
      },
      "users": {
        "index": false,
        "type": "text"
      },
      "tags": {
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart",
        "type": "text"
      },
      "mt": {
        "type": "keyword"
      },
      "mtName": {
        "type": "keyword"
      },
      "st": {
        "type": "keyword"
      },
      "stName": {
        "type": "keyword"
      },
      "grade": {
        "type": "keyword"
      },
      "teachmode": {
        "type": "keyword"
      },
      "pic": {
        "index": false,
        "type": "text"
      },
      "description": {
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart",
        "type": "text"
      },
      "createDate": {
        "format": "yyyy-MM-dd HH:mm:ss",
        "type": "date"
      },
      "status": {
        "type": "keyword"
      },
      "remark": {
        "index": false,
        "type": "text"
      },
      "charge": {
        "type": "keyword"
      },
      "price": {
        "type": "scaled_float",
        "scaling_factor": 100
      },
      "originalPrice": {
        "type": "scaled_float",
        "scaling_factor": 100
      },
      "validDays": {
        "type": "integer"
      }
    }
  }
}
```

## 查询索引

通过 GET /_cat/indices?v 查询所有的索引，查找course-publish是否创建成功。

通过GET /course-publish/_mapping 查询course-publish的索引结构。

## 删除索引

如果发现创建的course-publish不正确可以删除重新创建。

删除索引后当中的文档数据也同时删除，一定要谨慎操作！

删除索引命令：DELETE /course-publish

## 部署搜索服务

搭建search工程，启动网关和搜索服务，通过httpclient进行测试

```json
### 添加课程索引
POST {{search_host}}/search/index/course
Content-Type: application/json

{
  "charge" : "201000",
  "companyId" : 100000,
  "companyName" : "北京黑马程序",
  "createDate" : "2022-09-25 09:36:11",
  "description" : "《Spring编程思想》是2007年6月1日机械工业出版社出版的图书，作者是埃克尔，译者是陈昊鹏。主要内容本书赢得了全球程序员的广泛赞誉，即使是最晦涩的概念，在Bruce Eckel的文字亲和力和小而直接的编程示例面前也会化解于无形。从Java的基础语法到最高级特性（深入的面向对象概念、多线程、自动项目构建、单元测试和调试等），本书都能逐步指导你轻松掌握。从本书获得的各项大奖以及来自世界各地的读者评论中，不难看出这是一本经典之作",
  "grade" : "204001",
  "id" : 102,
  "mt" : "1-3",
  "mtName" : "编程开发",
  "name" : "Spring编程思想",
  "originalPrice" : 200.0,
  "pic" : "/mediafiles/2022/09/20/1d0f0e6ed8a0c4a89bfd304b84599d9c.png",
  "price" : 100.0,
  "remark" : "没有备注",
  "st" : "1-3-2",
  "stName" : "Java语言",
  "status" : "203002",
  "tags" : "没有标签",
  "teachmode" : "200002",
  "validDays" : 222
}



### 搜索课程
GET {{search_host}}/search/course/list?pageNo=1&keywords=spring
Content-Type: application/json

```

进入前端搜索界面http://www.51xuecheng.cn/course/search.html

# 索引管理

## REST API

 索引创建好，就可以向其进行增删改查操作，ElasticSearch会根据所以的mapping配置对对应字段分词 

> 添加文档

```bash
POST /{索引库名}/_doc/{id}
{
    json ...
}
```

> 查询文档

```bash
GET /{索引库名}/_doc/{id}
```

> 修改文档，分为全量修改和增量修改 

**全量修改**：本质是先根据id删除。在RestClient的API中，全量修改与新增的API完全一致，判断的依据是ID 

* 若新增时，ID已经存在，则修改(删除再新增)
* 若新增时，ID不存在，则新增 

```bash
POST /{索引库名}/_doc/{id}
{
    json ...
}
```

**增量修改**：修改文档中的指定字段值 

```bash
POST /{索引库名}/_update/{id}
{
    "doc":{
        "email":"BestApex@Apex.net",
        "info":"恐怖G7人--马文"
    }
}
```

> 更新文档

更新文档分为全量更新和局部更新。

全量更新是指先删除再更新，语法如下

```bash
PUT /{索引库名}/_doc/文档id
{
    "字段1": "值1",
    "字段2": "值2",
    // ... 略
}
```

局部更新语法如下：

```bash
POST /{索引库名}/_update/文档id
{
    "doc": {
         "字段名": "新的值",
    }
}
```

> 删除文档

删除文档将从索引中删除文档的记录。

```bash
DELETE /{索引库名}/_doc/id值
```

## 接口定义

当课程发布时请求添加课程接口添加课程信息到索引，当课程下架时请求删除课程接口从索引中删除课程信息，这里先实现添加课程接口。

根据索引的mapping结构创建po类：

```java
@Data
public class CourseIndex implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * 主键
     */
    private Long id;

    /**
     * 机构ID
     */
    private Long companyId;

    /**
     * 公司名称
     */
    private String companyName;

    /**
     * 课程名称
     */
    private String name;

    /**
     * 适用人群
     */
    private String users;

    /**
     * 标签
     */
    private String tags;


    /**
     * 大分类
     */
    private String mt;

    /**
     * 大分类名称
     */
    private String mtName;

    /**
     * 小分类
     */
    private String st;

    /**
     * 小分类名称
     */
    private String stName;



    /**
     * 课程等级
     */
    private String grade;

    /**
     * 教育模式
     */
    private String teachmode;
    /**
     * 课程图片
     */
    private String pic;

    /**
     * 课程介绍
     */
    private String description;


    /**
     * 发布时间
     */
    @JSONField(format="yyyy-MM-dd HH:mm:ss")
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private LocalDateTime createDate;

    /**
     * 状态
     */
    private String status;

    /**
     * 备注
     */
    private String remark;

    /**
     * 收费规则，对应数据字典--203
     */
    private String charge;

    /**
     * 现价
     */
    private Float price;
    /**
     * 原价
     */
    private Float originalPrice;

    /**
     * 课程有效期天数
     */
    private Integer validDays;
}
```

创建索引接口

```java
public class CourseIndexController {

    @ApiOperation("添加课程索引")
    @PostMapping("course")
    public Boolean add(@RequestBody CourseIndex courseIndex) {
    }
}
```

## 接口开发

定义service接口，请求elasticsearch添加课程信息。

注意：为了适应其它文档信息，将添加文档定义为通用的添加文档接口，此接口不仅适应添加课程还适应添加其它信息。

```java
public interface IndexService {

    /**
     * 添加索引
     *
     * @param indexName 索引名称
     * @param id        主键
     * @param object    索引对象
     * @return Boolean true表示成功,false失败
     */
    Boolean addCourseIndex(String indexName, String id, Object object);
}
```

```	java
@Override
public Boolean addCourseIndex(String indexName, String id, Object object) {
    String jsonString = JSON.toJSONString(object);
    IndexRequest indexRequest = new IndexRequest(indexName).id(id);
    // 指定索引文档内容
    indexRequest.source(jsonString, XContentType.JSON);
    // 索引响应对象
    IndexResponse indexResponse = null;
    try {
        indexResponse = client.index(indexRequest, RequestOptions.DEFAULT);
    } catch (IOException e) {
        log.error("添加索引出错:{}", e.getMessage());
        e.printStackTrace();
        BusinessException.cast("添加索引出错");
    }
    String name = indexResponse.getResult().name();
    log.info("name：{}", name);
    return name.equalsIgnoreCase("created") || name.equalsIgnoreCase("updated");

}
```

```java
@ApiOperation("添加课程索引")
@PostMapping("course")
public Boolean add(@RequestBody CourseIndex courseIndex) {

    Long id = courseIndex.getId();
    if (id == null) {
        BusinessException.cast("课程id为空");
    }
    Boolean result = indexService.addCourseIndex(courseIndexStore, String.valueOf(id), courseIndex);
    if (!result) {
        BusinessException.cast("添加课程索引失败");
    }
    return true;
}
```

## 接口测试

```json
### 添加课程索引
POST {{search_host}}/search/index/course
Content-Type: application/json

{
  "charge" : "201000",
  "companyId" : 100000,
  "companyName" : "北京黑马程序员",
  "createDate" : "2022-09-25 09:36:11",
  "description" : "《Java编程思想》是2007年6月1日机械工业出版社出版的图书，作者是埃克尔，译者是陈昊鹏。主要内容本书赢得了全球程序员的广泛赞誉，即使是最晦涩的概念，在Bruce Eckel的文字亲和力和小而直接的编程示例面前也会化解于无形。从Java的基础语法到最高级特性（深入的面向对象概念、多线程、自动项目构建、单元测试和调试等），本书都能逐步指导你轻松掌握。从本书获得的各项大奖以及来自世界各地的读者评论中，不难看出这是一本经典之作",
  "grade" : "204001",
  "id" : 102,
  "mt" : "1-3",
  "mtName" : "编程开发",
  "name" : "Java编程思想",
  "originalPrice" : 200.0,
  "pic" : "/mediafiles/2022/09/20/1d0f0e6ed8a0c4a89bfd304b84599d9c.png",
  "price" : 100.0,
  "remark" : "没有备注",
  "st" : "1-3-2",
  "stName" : "Java语言",
  "status" : "203002",
  "tags" : "没有标签",
  "teachmode" : "200002",
  "validDays" : 222
}
```

# 搜索

## 需求分析

索引信息维护完成下一步定义搜索接口搜索课程信息，首先需要搞清楚搜索功能的需求。

进入搜索界面，如下图：

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-132.png)

根据搜索界面可知需求如下：

1、根据一级分类、二级分类搜索课程信息。

2、根据关键字搜索课程信息，搜索方式为全文检索，关键字需要匹配课程的名称、 课程内容。

3、根据难度等级搜索课程。

4、搜索结点分页显示。

> 技术点：

1、整体采用布尔查询。

2、根据关键字搜索，采用MultiMatchQuery，搜索name、description字段。

3、根据分类、课程等级搜索采用过滤器实现。

4、分页查询。

5、高亮显示。



> 为什么课程分类、课程等级等查询使用过滤器方式？

使用关键字查询需要计算相关度得分，根据课程分类、课程等级去查询不需要计算相关度得分，使用过滤器实现根据课程分类、课程等级查询的过程不会计算相关度得分，效率更高。

## 接口定义

定义搜索条件DTO类

```java
@Data
@ToString
public class SearchCourseParamDto {

    // 关键字
    private String keywords;

    // 大分类
    private String mt;

    // 小分类
    private String st;
    // 难度等级
    private String grade;

}
```

为了适应后期的扩展，定义搜索结果类，让它继承PageResult  

```java
@Data
@ToString
public class SearchPageResultDto<T> extends PageResult {

    // 大分类列表
    List<String> mtList;
    // 小分类列表
    List<String> stList;

    public SearchPageResultDto(List<T> items, long counts, long page, long pageSize) {
        super(items, counts, page, pageSize);
    }

}
```

定义搜索接口

```java
@RestController
@RequestMapping("/course")
@Api(value = "课程搜索接口", tags = "课程搜索接口")
public class CourseSearchController {

    @Resource
    private CourseSearchService courseSearchService;

    @ApiOperation("课程搜索列表")
    @GetMapping("/list")
    public SearchPageResultDto<CourseIndex> list(PageParams pageParams, SearchCourseParamDto searchCourseParamDto) {
    }
}
```

## 基本功能实现

```java
public interface CourseSearchService {


    /**
     * 搜索课程列表
     *
     * @param pageParams 分页参数
     * @param searchCourseParamDto 搜索条件
    */
    SearchPageResultDto<CourseIndex> queryCoursePubIndex(PageParams pageParams, SearchCourseParamDto searchCourseParamDto);

}
```

> 根据分页搜索

```java
public SearchPageResultDto<CourseIndex> queryCoursePubIndexByPage(PageParams pageParams, SearchCourseParamDto courseSearchParam) {

    // 1. 准备Request对象
    SearchRequest request = new SearchRequest(courseIndexStore);
    // 2. 组织DSL参数，这里使用布尔查询
    BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();
    String[] sourceFieldsArray = sourceFields.split(",");
    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
    // sourceFieldsArray指定要返回的字段，new String[]{}指定不返回的字段
    searchSourceBuilder.fetchSource(sourceFieldsArray, new String[]{});
    // 3. 分页
    Long pageNo = pageParams.getPageNo();
    Long pageSize = pageParams.getPageSize();
    // 3.1 指定起始查询位置和查询条数
    int start = (int) ((pageNo - 1) * pageSize);
    searchSourceBuilder.from(start)
            .size(Math.toIntExact(pageSize));
    // 4. 布尔查询
    searchSourceBuilder.query(boolQuery);
    request.source(searchSourceBuilder);
    // 5. 发送请求，获取响应结果
    SearchResponse response = null;
    try {
        response = client.search(request, RequestOptions.DEFAULT);
    } catch (IOException e) {
        log.debug("课程搜索异常：{}", e.getMessage());
        return new SearchPageResultDto<>(new ArrayList<>(), 0, 0, 0);
    }
    // 6. 解析响应
    SearchHits searchHits = response.getHits();
    // 6.1 获取总条数
    long totalHits = searchHits.getTotalHits().value;
    // 6.2 获取文档数组
    SearchHit[] hits = searchHits.getHits();
    ArrayList<CourseIndex> list = new ArrayList<>();
    // 6.3 遍历
    for (SearchHit hit : hits) {
        // 获取文档source
        String jsonCourseString = hit.getSourceAsString();
        // 转为CourseIndex对象，加入到集合中
        CourseIndex courseIndex = JSON.parseObject(jsonCourseString, CourseIndex.class);
        list.add(courseIndex);
    }
    // 7. 封装结果
    SearchPageResultDto<CourseIndex> pageResult = new SearchPageResultDto<>(list, totalHits, pageNo, pageSize);
    return pageResult;
}
```

## 根据条件搜索

```java
/**
 * 根据关键字、一级分类、二级分类、难度等级搜索
 */
public SearchPageResultDto<CourseIndex> queryCoursePubIndexByCondition(PageParams pageParams, SearchCourseParamDto courseSearchParam) {
    // 1. 准备Request对象
    SearchRequest request = new SearchRequest(courseIndexStore);
    // 2. 组织DSL参数，这里使用布尔查询
    BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();
    String[] sourceFieldsArray = sourceFields.split(",");
    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
    // sourceFieldsArray指定要返回的字段，new String[]{}指定不返回的字段
    searchSourceBuilder.fetchSource(sourceFieldsArray, new String[]{});
    // 3. 分页
    Long pageNo = pageParams.getPageNo();
    Long pageSize = pageParams.getPageSize();
    // 3.1 指定起始查询位置和查询条数
    int start = (int) ((pageNo - 1) * pageSize);
    searchSourceBuilder.from(start)
            .size(Math.toIntExact(pageSize));
    // 3.2 指定条件查询
    if (courseSearchParam == null) {
        courseSearchParam = new SearchCourseParamDto();
    }
    // 3.2.1 匹配关键字
    if (StringUtils.isNotEmpty(courseSearchParam.getKeywords())) {
        String keywords = courseSearchParam.getKeywords();
        boolQuery.must(QueryBuilders
                .multiMatchQuery(keywords, "name", "description")
                .minimumShouldMatch("70%")
                .field("name", 10));
    }
    // 3.2.2 匹配大分类
    if (StringUtils.isNotEmpty(courseSearchParam.getMt())) {
        boolQuery.filter(QueryBuilders
                .termQuery("mtName", courseSearchParam.getMt()));
    }
    // 3.2.3 匹配小分类
    if (StringUtils.isNotEmpty(courseSearchParam.getSt())) {
        boolQuery.filter(QueryBuilders
                .termQuery("stName", courseSearchParam.getSt()));
    }
    // 3.2.4 匹配难度
    if (StringUtils.isNotEmpty(courseSearchParam.getGrade())) {
        boolQuery.filter(QueryBuilders
                .termQuery("grade", courseSearchParam.getGrade()));
    }
    // 4. 布尔查询
    searchSourceBuilder.query(boolQuery);
    request.source(searchSourceBuilder);
    // 5. 发送请求，获取响应结果
    SearchResponse response = null;
    try {
        response = client.search(request, RequestOptions.DEFAULT);
    } catch (IOException e) {
        log.debug("课程搜索异常：{}", e.getMessage());
        return new SearchPageResultDto<>(new ArrayList<>(), 0, 0, 0);
    }
    // 6. 解析响应
    SearchHits searchHits = response.getHits();
    // 6.1 获取总条数
    long totalHits = searchHits.getTotalHits().value;
    // 6.2 获取文档数组
    SearchHit[] hits = searchHits.getHits();
    ArrayList<CourseIndex> list = new ArrayList<>();
    // 6.3 遍历
    for (SearchHit hit : hits) {
        // 获取文档source
        String jsonCourseString = hit.getSourceAsString();
        // 转为CourseIndex对象，加入到集合中
        CourseIndex courseIndex = JSON.parseObject(jsonCourseString, CourseIndex.class);
        list.add(courseIndex);
    }
    // 7. 封装结果
    SearchPageResultDto<CourseIndex> pageResult = new SearchPageResultDto<>(list, totalHits, pageNo, pageSize);
    return pageResult;
}
```

进入搜索界面，输入关键字进行测试。

一级分类、二级分类在下边的聚合搜索中测试。

## 聚合搜索

搜索界面上显示的一级分类、二级分类来源于搜索结果，使用聚合搜索实现找到搜索结果中的一级分类、二级分类。

[具体参考文档](https://cyborg2077.github.io/2023/02/28/XuechengOnlinePart4/)

# 课程索引信息同步

## 技术方案

通过向索引中添加课程信息最终实现了课程的搜索，我们发现课程信息是先保存在关系数据库中，而后再写入索引，这个过程是**将关系数据中的数据同步到elasticsearch索引中的过程**，可以简单成为索引同步。

通常项目中使用elasticsearch需要完成索引同步，索引同步的方法很多：

1、针对实时性非常高的场景需要满足数据的及时同步，可以同步调用，或使用Canal去实现。

* 同步调用即在向MySQL写数据后远程调用搜索服务的接口写入索引，此方法简单但是耦合代码太高。

* 可以使用一个中间的软件canal解决耦合性的问题，但存在学习与维护成本。

> canal

canal主要用途是**基于 MySQL 数据库增量日志解析，并能提供增量数据订阅和消费，实现将MySQL的数据同步到消息队列、Elasticsearch、其它数据库**等，应用场景十分丰富。 

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-133.png)

[Canal](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-133.png)基于mysql的binlog技术实现数据同步，binlog是一个文件，记录了对数据库更新的SQL语句，向数据库写数据的同时向binlog文件里记录对应的sql语句。当数据库服务器发生了故障就可以使用binlog文件对数据库进行恢复。使用canal是需要开启mysql的binlog写入功能，Canal工作原理如下  

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-134.png)

1、canal 模拟 MySQL slave 的交互协议，伪装自己为 MySQL slave ，向 MySQL master 发送dump 

协议 

2、MySQL master 收到 dump 请求，开始推送 binary log 给 slave (即 canal ) 

3、canal 解析 binary log 对象(原始为 byte 流)

> 当索引同步的实时性要求不高时可用，比如：MQ、Logstash、任务调度等。

**MQ**：向mysql写数据的时候向mq写入消息，搜索服务监听MQ，收到消息后写入索引。使用MQ的优势是代码解耦，但是需要处理消息可靠性的问题有一定的技术成本，做到消息可靠性需要做到生产者投递成功、消息持久化以及消费者消费成功三个方面，另外还要做好消息幂等性问题。

**Logstash**： 开源实时日志分析平台 ELK包括Elasticsearch、Kibana、Logstash，Logstash负责收集、解析和转换日志信息，可以实现MySQL与Elasticsearch之间的数据同步。也可以实现解耦合并且是官方推荐，但需要增加学习与维护成本。

**任务调度**：向mysql写数据的时候记录修改记录，开启一个定时任务根据修改记录将数据同步到Elasticsearch。

根据本项目的需求，课程发布后信息同步的实时性要求不高，从提交审核到发布成功一般两个工作日完成。综合比较以上技术方案本项目的索引同步技术使用任务调度的方法。

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-135.png)

1. 课程发布向消息表插入记录。

2. 任务调度程序通过消息处理SDK对消息记录进行处理。

3. 向elasticsearch索引中保存课程信息。

> 向elasticsearch索引中保存课程信息执行流程如下：

由内容管理服务远程调用搜索服务**添加课程信息索引**，搜索服务再请求elasticsearch向**课程索引中添加文档。**

## 课程索引任务开发

**向内容管理服务中添加FeignClient**

```java
@FeignClient(value = "search")
public interface SearchServiceClient {

    @PostMapping("/search/index/course")
    Boolean add(@RequestBody CourseIndex courseIndex);
}
```

**编写课程索引任务执行方法，在课程发布Service中定义保存课程索引方法** 

```java
/**
* 保存课程索引
* @param courseId  课程id
* @return
*/
Boolean saveCourseIndex(Long courseId);
```

```java
@Override
public Boolean saveCourseIndex(Long courseId) {
    // 1. 取出课程发布信息
    CoursePublish coursePublish = coursePublishMapper.selectById(courseId);
    // 2. 拷贝至课程索引对象
    CourseIndex courseIndex = new CourseIndex();
    BeanUtils.copyProperties(coursePublish, courseIndex);
    // 3. 远程调用搜索服务API，添加课程索引信息
    Boolean result = searchServiceClient.add(courseIndex);
    if (!result) {
        XueChengPlusException.cast("添加索引失败");
    }
    return true;
}
```

 **完善CoursePublishTask类中的saveCourseIndex方法** 

```java
public void saveCourseIndex(MqMessage mqMessage, Long courseId) {
    log.debug("正在保存课程信息索引，课程id:{}", courseId);
    // 1. 获取消息id
    Long id = mqMessage.getId();
    // 2. 获取小任务阶段状态
    MqMessageService mqMessageService = this.getMqMessageService();
    int stageTwo = mqMessageService.getStageTwo(id);
    // 3. 当前小任务完成，无需再次处理
    if (stageTwo == 1) {
        log.debug("当前阶段为创建课程索引任务，已完成，无需再次处理，任务信息：{}", mqMessage);
        return;
    }
    // 4. 远程调用保存课程索引接口，将课程信息上传至ElasticSearch
    Boolean result = coursePublishService.saveCourseIndex(courseId);
    if (result) {
        mqMessageService.completedStageTwo(id);
    }
}
```

