# 存在问题

目前为止共三个三微服务：内容管理、系统管理、媒资管理  

后期还会添加更多的微服务，当前这种由前端直接请求微服务的方式存在弊端：

如果在前端对每个请求地址都配置绝对路径，非常不利于系统维护

基于这个问题可以采用网关来解决  

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-51.png)

在前端的代码中只需要指定每个接口的相对路径 ，在前端代码的一个固定的地方在接口地址前统一加网关的地址，每个请求统一到网关，由网关将请求转发到具体的微服务  

项目采用Spring Cloud Gateway作为网关，网关在请求路由时需要知道每个微服务实例的地址，项目使用Nacos作用服务发现中心和配置中心  

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-52.png)

> 流程

1. 微服务启动，将自己注册到Nacos，Nacos记录了各微服务实例的地址 
2. 网关从Nacos读取服务列表，包括服务名称、服务地址等
3. 网关从Nacos读取服务列表，包括服务名称、服务地址等  

> Nacos两个作用

1. 服务发现中心：微服务将自身注册至Nacos，网关从Nacos获取微服务列表
2. 配置中心：微服务众多，它们的配置信息也非常复杂，为了提供系统的可维护性，微服务的配置信息统一在Nacos配置  

# 搭建Nacos

## 服务发现中心

namespace：用于区分环境、比如：开发环境、测试环境、生产环境。

group：用于区分项目

**新增开发环境命名空间，将各微服务注册到Nacos，在父工程和内容管理、系统管理微服务模块中引入依赖**

> Linux安装Nacos

```shell
# 拉去镜像
docker pull nacos/nacos-server:1.4.1

# 创建并运行一个容器
docker run --name nacos -e MODE=standalone -p 8849:8848 -d nacos/nacos-server:1.4.1
```

> 父工程

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-alibaba-dependencies</artifactId>
    <version>${spring-cloud-alibaba.version}</version>
    <type>pom</type>
    <scope>import</scope>
</dependency>
```

> 在内容管理模块的接口工程、系统管理模块的接口工程中添加如下依赖

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

> 配置nacos地址

 在content-service的application.yml中配置如下信息 （service模块无需进行服务注册）

```yml
spring:
  application:
    name: content-service
  cloud:
    nacos:
#      discovery: # 服务注册
#        server-addr: localhost:8848
#        namespace: ${spring.profiles.active}
#        group: online-education-backend
```

 在system-service的application.yml中配置如下信息 

```yml
spring:
  application:
    name: system-service
  cloud:
    nacos:
      server-addr: 127.0.0.1:8848
      discovery:
        namespace: dev
        group: xuecheng-plus-project
```

> 将两个微服务注册进Nacos

**系统管理服务**



**内容管理服务**

```yml

```



## 配置中心

> 配置文件分分类：

**每个项目特有的配置**

**项目所公用的配置**  

> 配置三要素

1. 通过namespace、group找到具体的环境和具体的项目  
2. 通过dataid找到具体的配置文件，dataid由三部分组成  

content-service-dev.yaml配置文件 由（content-service）-（dev）. (yaml)三部分组成

| 字段            | 说明                        |
| --------------- | --------------------------- |
| content-service | spring.application.name指定 |
| dev             | spring.profiles.active指定  |
| yaml            | file-extension: yaml指定    |

在开发环境中配置content-service-dev.yaml

在测试环境中配置content-service-test.yaml

在生产环境中配置content-service-prod.yaml

> 配置content-service

进入nacos，添加配置

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-53.png)

本地配置文件现在是application.yaml需要修改为bootstrap.yaml，因为SpringBoot读取配置文件 的顺序如下：

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-54.png)

 在content-service工程 中添加bootstrap.yaml  

```yml
spring:
  application:
    name: online-education-content-service
  cloud:
    nacos:
      discovery: # 服务注册
        server-addr: localhost:8848
        namespace: ${spring.profiles.active}
        group: online-education-backend
      config: # 配置中心
        server-addr: localhost:8848
        namespace: ${spring.profiles.active}
        group: online-education-backend
        file-extension: yaml
        refresh-enabled: true
  profiles:
    active: dev # 环境名
```

在内容管理模块的接口工程和service工程、系统管理的接口工程和service工程配置依赖  

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```

> 配置cotent-api

以相同的方法配置content-api工程的配置文件，在nacos中的开发环境中配置content-api-dev.yaml  

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-56.png)

```yml
server:
  servlet:
    context-path: /content
  port: 63040

# 日志文件配置路径
logging:
  config: classpath:log4j2-dev.xml

swagger:
  title: "在线教育网站"
  description: "内容系统管理系统对课程相关信息进行业务管理数据"
  base-package: com.cyan.springcloud.content
  enabled: true
  version: 1.0.0
```

在content-api工程 的本地配置bootstrap.yaml  

```yml
spring:
  application:
    name: online-education-content-api
  cloud:
    nacos:
      discovery: # 服务注册
        server-addr: localhost:8848
        namespace: dev
        group: online-education-backend
      config: # 配置中心
        server-addr: localhost:8848
        namespace: dev
        group: online-education-backend
        file-extension: yaml
        refresh-enabled: true
        extension-configs:
          - data-id: online-education-content-service-${spring.profiles.active}.yaml
            group: online-education-backend
            refresh: true
  profiles:
    active: dev # 环境名


logging:
  config: classpath:log4j2-dev.xml

#server: # 已在Nacos中配置
#  servlet:
#    context-path: /content
#  port: 63040

swagger:
  title: "在线教育网站"
  description: "内容系统管理系统对课程相关信息进行业务管理数据"
  base-package: com.cyan.springcloud.content
  enabled: true
  version: 1.0.0
```

因为api接口工程依赖了service工程 的jar，所以这里使用extension-configs扩展配置文件的方式引用service工程所用到的配置文件  

```yml
spring:
  application:
    name: online-education-content-api
  cloud:
    nacos:
      config: # 配置中心
        server-addr: localhost:8848
        namespace: dev
        group: online-education-backend
        file-extension: yaml
        refresh-enabled: true
        extension-configs:
          - data-id: online-education-content-service-${spring.profiles.active}.yaml
            group: online-education-backend
            refresh: true
```

## 公用配置

nacos提供了shared-configs可以引入公用配置。在content-api中配置了swagger，所有的接口工程都需要配置swagger，这里就可以将swagger的配置定义为一个公用配置，哪个项目用引入即可。

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-55.png)

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-57.png)

```yml
        shared-configs: # 公共配置
        - data-id: swagger-${spring.profiles.active}.yaml
          group: online-education-common
          refresh: true
        - data-id: logging-${spring.profiles.active}.yaml
          group: online-education-common
          refresh: true
```

项目使用shared-configs可以引入公用配置。在接口工程的本地配置文件 中引入公用配置  

```yml
spring:
  application:
    name: online-education-content-api
  cloud:
    nacos:
      discovery: # 服务注册
        server-addr: localhost:8848
        namespace: dev
        group: online-education-backend
      config: # 配置中心
        server-addr: localhost:8848
        namespace: dev
        group: online-education-backend
        file-extension: yaml
        refresh-enabled: true
        extension-configs: # 引用配置
          - data-id: online-education-content-service-${spring.profiles.active}.yaml
            group: online-education-backend
            refresh: true
        shared-configs: # 公共配置
        - data-id: swagger-${spring.profiles.active}.yaml
          group: online-education-common
          refresh: true
        - data-id: logging-${spring.profiles.active}.yaml
          group: online-education-common
          refresh: true
  profiles:
    active: dev # 环境名
```

 配置完成，重启content-api接口工程，访问http://localhost:63040/content/swagger-ui.html 查看swagger接口文档是否可以正常访问，查看控制台log4j2日志输出是否正常  

## 系统管理配置

## 配置优先级

> 到目前为止已将所有微服务的配置统一在nacos进行配置，用到的配置文件有本地的配置文件 bootstrap.yaml和nacos上的配置文件，引入配置文件的形式有  

1.  通过dataid方式引入  
2.  以扩展配置文件方式引入  
3. 以共享配置文件 方式引入  

> 配置优先级

**项目应用名配置文件 > 扩展配置文件 > 共享配置文件 > 本地配置文件。**

## 导入配置文件

进入具体的命名空间，点击“导入配置”