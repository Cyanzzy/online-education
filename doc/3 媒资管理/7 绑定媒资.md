# 需求分析

> 业务流程

1. 教育机构用户进入课程管理页面并编辑某一个课程，在"课程大纲"标签页的某一小节后可点击”添加视频“。  

   ![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-84.png)

2. 弹出添加视频对话框，可通过视频关键字搜索已审核通过的视频媒资  

3. 选择视频媒资，点击提交按钮，完成课程计划绑定媒资流程  

课程计划关联视频后如下图  

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-85.png)

点击已经绑定的视频名称即可解除绑定。

> 数据模型

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-86.png)

# 接口定义

前端以json格式请求以下参数：提交媒资文件id、文件名称、教学计划id

```json
{
  "mediaId": "70a98b4a2fffc89e50b101f959cc33ca",
  "fileName": "22-Hmily实现TCC事务-开发bank2的confirm方法.avi",
  "teachplanId": 257
}
```

根据业务流程，用户进入课程计划列表，首先确定向哪个课程计划添加视频，点击”添加视频“后用户选择视频，选择视频，点击提交， 此接口在内容管理模块提供  

> 在内容管理模块定义请求参数模型类型：

```java
@Data
@ApiModel(value="BindTeachplanMediaDto", description="教学计划-媒资绑定提交数据")
public class BindTeachplanMediaDto {

    @ApiModelProperty(value = "媒资文件id", required = true)
    private String mediaId;

    @ApiModelProperty(value = "媒资文件名称", required = true)
    private String fileName;

    @ApiModelProperty(value = "课程计划标识", required = true)
    private Long teachplanId;

}
```

在TeachplanController类中定义接口如下：

```java
@ApiOperation(value = "课程计划和媒资信息绑定")
@PostMapping("/teachplan/association/media")
public void associationMedia(@RequestBody BindTeachplanMediaDto bindTeachplanMediaDto) {

}
```

# 接口开发

```java
/**
 * 教学计划绑定媒资
 *
 * @param bindTeachplanMediaDto
 */
TeachplanMedia associationMedia(BindTeachplanMediaDto bindTeachplanMediaDto);
```

```java
@Override
@Transactional
public TeachplanMedia associationMedia(BindTeachplanMediaDto bindTeachplanMediaDto) {

    // 教学计划id
    Long teachplanId = bindTeachplanMediaDto.getTeachplanId();
    Teachplan teachplan = teachplanMapper.selectById(teachplanId);
    if (teachplan == null) {
        BusinessException.cast("教学计划不存在");
    }
    Integer grade = teachplan.getGrade();
    if (grade != 2) {
        BusinessException.cast("只允许第二级教学计划绑定媒资文件");
    }
    // 课程id
    Long courseId = teachplan.getCourseId();


    // 根据课程计划Id删除原先绑定的媒资信息
    LambdaQueryWrapper<TeachplanMedia> queryWrapper = new LambdaQueryWrapper<>();
    queryWrapper.eq(TeachplanMedia::getTeachplanId, teachplanId);
    int delete = teachplanMediaMapper.delete(queryWrapper);

    // 再添加教学计划与媒资的绑定关系
    TeachplanMedia teachplanMedia = new TeachplanMedia();

    teachplanMedia.setCourseId(courseId);
    teachplanMedia.setTeachplanId(teachplanId);
    teachplanMedia.setMediaFilename(bindTeachplanMediaDto.getFileName());
    teachplanMedia.setMediaId(bindTeachplanMediaDto.getMediaId());
    teachplanMedia.setCreateDate(LocalDateTime.now());
    teachplanMediaMapper.insert(teachplanMedia);

    return teachplanMedia;
}
```

# 解除绑定功能

点击已经绑定的视频名称即可解除绑定  

> 接口定义

```json
delete /teachplan/association/media/{teachPlanId}/{mediaId}

返回200状态码表示成功。
```

```java
@ApiOperation("课程计划解除媒资信息绑定")
@DeleteMapping("/teachplan/association/media/{teachPlanId}/{mediaId}")
public void unassociationMedia(@PathVariable Long teachPlanId, @PathVariable Long mediaId) {
    
}
```

> 接口开发

```java
/**
 * 解绑教学计划与媒资信息
 *
 * @param teachPlanId       教学计划id
 * @param mediaId           媒资信息id
 */
void unassociationMedia(Long teachPlanId, Long mediaId);
```

```java
@Override
public void unassociationMedia(Long teachPlanId, Long mediaId) {
    LambdaQueryWrapper<TeachplanMedia> queryWrapper = new LambdaQueryWrapper<>();

    queryWrapper.eq(TeachplanMedia::getTeachplanId, teachPlanId)
            .eq(TeachplanMedia::getMediaId, mediaId);
    teachplanMediaMapper.delete(queryWrapper);
}
```

