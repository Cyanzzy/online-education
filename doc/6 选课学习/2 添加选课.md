# 需求分析

## 数据模型

选课是将课程加入我的课程表的过程，根据选课的业务流程进行详细分析  

> 业务流程

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-190.png)

选课信息存入选课记录表，免费课程被选课除了进入选课记录表同时进入我的课程表，收费课程进入选课记录表后需要经过下单、支付成功才可以进入我的课程表。

我的课程表记录了用户学习的课程，包括免费课程、收费课程（已经支付）。

> 选课记录表

当用户将课程添加到课程表时需要先创建选课记录  

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-191.png)

选课类型：免费课程、收费课程。

选课状态：选课成功、待支付、选课删除。

对于免费课程：课程价格为0，有效期默认365，开始服务时间为选课时间，结束服务时间为选课时间加1年后的时间，选课状态为选课成功。

对于收费课程：按课程的现价、有效期确定开始服务时间、结束服务时间，选课状态为待支付。

收费课程的选课记录需要支付成功后选课状态为成功。

> 我的课程表

我的课程表中记录了用户选课成功的课程，所以我的课程表的数据来源于选课记录表。 

对于免费课程创建选课记录后同时向我的课程表添加记录。

对于收费课程创建选课记录后需要下单支付成功后自动向我的课程表添加记录

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-192.png)

## 执行流程

在学习引导处，可以直接将免费课程加入我的课程表  

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-184.png)

> 对于收费课程先创建选课记录表，支付成功后，收到支付结果由系统自动加入我的课程表。
>
> 执行流程

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-193.png)

# 接口开发

## 部署学习中心工程

部署服务，配置数据库和nacos配置文件

## 添加查询课程接口

内容管理服务提供查询课程信息接口，此接口从课程发布表查询。

此接口主要提供其它微服务远程调用，所以此接口不用授权，本项目标记此类接口统一以 /r开头。

在课程发布controller类中定义课程发布信息查询接口  

```java
@ApiOperation("查询课程发布信息")
@ResponseBody
@GetMapping("/r/coursepublish/{courseId}")
public CoursePublish getCoursepublish(@PathVariable("courseId") Long courseId) {
    CoursePublish coursePublish = coursePublishService.getCoursePublish(courseId);
     return coursePublish;
}
```

Service如下：

如果课程发布状态正常则正常返回，否则返回空。

```java
@Override
public CoursePublish getCoursePublish(Long courseId) {
    return coursePublishMapper.selectById(courseId);
}
```

测试：

启动内容管理服务，使用httpclient测试

```json
### 查询课程发布信息
GET {{content_host}}/content/r/coursepublish/2
```

由于是在网关处进行令牌校验，所以在微服务处不再校验令牌的合法性，修改内容管理content-api工程的ResouceServerConfig类，屏蔽authenticated()。

```java
@Override
public void configure(HttpSecurity http) throws Exception {
http.csrf().disable()
      .authorizeRequests()
//          .antMatchers("/r/**","/course/**").authenticated()//所有/r/**的请求必须认证通过
      .anyRequest().permitAll()
;
}
```

## 测试查询课程信息接口  

学生中心服务远程调用内容管理服务的查询课程发布信息接口。

导入的学习中心工程已经存在ContentServiceClient 

```java
@SpringBootTest
public class FeignClientTest {

    @Resource
    private ContentServiceClient contentServiceClient;

    @Test
    public void testContentServiceClient(){
        CoursePublish coursepublish = contentServiceClient.getCoursepublish(117L);
        System.out.println(coursepublish);
        Assertions.assertNotNull(coursepublish);
    }

}
```

**Notice：**

learning-service模块记得注册进nacos否则发现不了api

java.lang.RuntimeException: com.netflix.client.ClientException: Load balancer does not have available server for client: content-api

## 添加选课接口

> 接口分析

本接口支持免费课程选课、收费课程选课。

免费课程选课：添加选课记录、添加我的课程表。

收费课程选课：添加选课记录

> 接口定义

````json
1、请求参数：课程id、当前用户id
2、响应结果：选课记录信息、学习资格
学习资格：[{"code":"702001","desc":"正常学习"},{"code":"702002","desc":"没有选课或选课后没有支付"},{"code":"702003","desc":"已过期需要申请续期或重新支付"}]
````

```java

@Api(value = "我的课程表接口", tags = "我的课程表接口")
@Slf4j
@RestController
public class MyCourseTablesController {


    @ApiOperation("添加选课")
    @PostMapping("/choosecourse/{courseId}")
    public XcChooseCourseDto addChooseCourse(@PathVariable("courseId") Long courseId) {

        return null;
    }
}
```

> 定义Service接口

```java
public interface MyCourseTablesService {

    /**
     * 添加选课
     *
     * @param userId   用户id
     * @param courseId 课程id
     */
    XcChooseCourseDto addChooseCourse(String userId, Long courseId);
}
```

```java
@Override
@Transactional
public XcChooseCourseDto addChooseCourse(String userId, Long courseId) {

    // 选课调用内容管理查询课程的收费规则
    CoursePublish coursepublish = contentServiceClient.getCoursepublish(courseId);

    if (coursepublish == null) {
        BusinessException.cast("课程不存在");
    }

    // 收费规则
    String charge = coursepublish.getCharge();
    if ("201000".equals(charge)) { // 课程免费
        // 如果课程免费，向选课记录表、我的课程表写数据
        XcChooseCourse xcChooseCourse = addFreeCourse(userId, coursepublish); // 选课记录表
        XcCourseTables xcCourseTables = addCourseTables(xcChooseCourse); //我的课程表
    } else {
        // 如果课程收费，向选课记录表写数据
        XcChooseCourse xcChooseCourse = addChargeCourse(userId, coursepublish); // 选课记录表
    }

    // 判断学生的学习资格

    return null;
}
```

## 添加免费课程

```java
private XcChooseCourse addFreeCourse(String userId, CoursePublish coursePublish) {

    // 课程id
    Long courseId = coursePublish.getId();
    // 如果存在免费的选课记录 && 选课状态==成功 --> 返回
    LambdaQueryWrapper<XcChooseCourse> queryWrapper = new LambdaQueryWrapper<>();
    queryWrapper
            .eq(XcChooseCourse::getUserId, userId)
            .eq(XcChooseCourse::getCourseId, courseId)
            .eq(XcChooseCourse::getOrderType, "700001") // 免费课程
            .eq(XcChooseCourse::getStatus, "701001"); // 选课成功
    List<XcChooseCourse> list = xcChooseCourseMapper.selectList(queryWrapper);

    if (list.size() > 0) {
        return list.get(0);
    }

    // 向选课记录表写数据
    XcChooseCourse xcChooseCourse = new XcChooseCourse();

    xcChooseCourse.setCourseId(courseId);
    xcChooseCourse.setCourseName(coursePublish.getName());
    xcChooseCourse.setUserId(userId);
    xcChooseCourse.setCompanyId(coursePublish.getCompanyId());
    xcChooseCourse.setOrderType("700001"); // 免费课程
    xcChooseCourse.setCreateDate(LocalDateTime.now());
    xcChooseCourse.setCoursePrice(coursePublish.getPrice());
    xcChooseCourse.setStatus("701001"); // 选课成功
    xcChooseCourse.setValidDays(365); // 课程有效期
    xcChooseCourse.setValidtimeStart(LocalDateTime.now()); // 有效期开始时间
    xcChooseCourse.setValidtimeEnd(LocalDateTime.now().plusDays(365)); // 有效期结束时间

    int insert = xcChooseCourseMapper.insert(xcChooseCourse);

    if (insert <= 0) {
        BusinessException.cast("添加选课记录失败");
    }

    return xcChooseCourse;
}
```

## 添加我的课程表

我的课程表的记录来源于选课记录，选课记录成功将课程信息添加到我的课程表。

如果我的课程表已存在课程可能已经过期，如果有新的选课记录则需要更新我的课程表中的现有信息。

```java
private XcCourseTables addCourseTables(XcChooseCourse chooseCourse) {

    // 选课成功，才能向我的课程表添加
    String status = chooseCourse.getStatus();
    if (!"701001".equals(status)) {
        BusinessException.cast("选课未成功，无法添加记录到课程表");
    }
    XcCourseTables  xcCourseTables = getXcCourseTables(chooseCourse.getUserId(), chooseCourse.getCourseId());
    if (xcCourseTables != null) {
        return xcCourseTables;
    }
    xcCourseTables  = new XcCourseTables();
    BeanUtils.copyProperties(chooseCourse, xcCourseTables);

    xcCourseTables.setChooseCourseId(chooseCourse.getId()); // 记录选课表的id
    xcCourseTables.setCourseType(chooseCourse.getOrderType()); // 选课类型
    xcCourseTables.setUpdateDate(LocalDateTime.now());

    int insert = xcCourseTablesMapper.insert(xcCourseTables);
    if (insert <= 0) {
        BusinessException.cast("添加我的课程表失败");
    }

    return xcCourseTables;
}
```

## 添加收费课程

```java
private XcChooseCourse addChargeCourse(String userId, CoursePublish coursePublish) {
    // 课程id
    Long courseId = coursePublish.getId();
    // 如果存在收费的选课记录 && 选课状态==待支付 --> 返回
    LambdaQueryWrapper<XcChooseCourse> queryWrapper = new LambdaQueryWrapper<>();
    queryWrapper
            .eq(XcChooseCourse::getUserId, userId)
            .eq(XcChooseCourse::getCourseId, courseId)
            .eq(XcChooseCourse::getOrderType, "700002") // 收费课程
            .eq(XcChooseCourse::getStatus, "701002"); // 待支付
    List<XcChooseCourse> list = xcChooseCourseMapper.selectList(queryWrapper);

    if (list.size() > 0) {
        return list.get(0);
    }

    // 向选课记录表写数据
    XcChooseCourse xcChooseCourse = new XcChooseCourse();

    xcChooseCourse.setCourseId(courseId);
    xcChooseCourse.setCourseName(coursePublish.getName());
    xcChooseCourse.setUserId(userId);
    xcChooseCourse.setCompanyId(coursePublish.getCompanyId());
    xcChooseCourse.setOrderType("700002"); // 收费课程
    xcChooseCourse.setCreateDate(LocalDateTime.now());
    xcChooseCourse.setCoursePrice(coursePublish.getPrice());
    xcChooseCourse.setStatus("701002"); // 待支付
    xcChooseCourse.setValidDays(365); // 课程有效期
    xcChooseCourse.setValidtimeStart(LocalDateTime.now()); // 有效期开始时间
    xcChooseCourse.setValidtimeEnd(LocalDateTime.now().plusDays(365)); // 有效期结束时间

    int insert = xcChooseCourseMapper.insert(xcChooseCourse);

    if (insert <= 0) {
        BusinessException.cast("添加选课记录失败");
    }

    return xcChooseCourse;
}
```

## 查询学习资格

```java
/**
 * 判断学习资格
 *
 * @param userId
 * @param courseId
 */
XcCourseTablesDto getLearningStatus(String userId, Long courseId);
```

```java
@Override
public XcCourseTablesDto getLearningStatus(String userId, Long courseId) {

    XcCourseTablesDto xcCourseTablesDto = new XcCourseTablesDto();

    // 查询我的课程表，如果没有记录，说明没有选课
    XcCourseTables xcCourseTables = getXcCourseTables(userId, courseId);
    if (xcCourseTables == null) {
        // {"code":"702002","desc":"没有选课或选课后没有支付"},
        xcCourseTablesDto.setLearnStatus("702002");

        return xcCourseTablesDto;
    }

    // 如果查询到记录，判断是否过期，如果过期不能继续学习；如果未过期，可以继续学习
    boolean before = xcCourseTables.getValidtimeEnd().isBefore(LocalDateTime.now());
    if (before) {
        // {"code":"702003","desc":"已过期需要申请续期或重新支付"}
        BeanUtils.copyProperties(xcCourseTables, xcCourseTablesDto);
        xcCourseTablesDto.setLearnStatus("702003");

        return xcCourseTablesDto;
    } else {
        // {"code":"702001","desc":"正常学习"},
        BeanUtils.copyProperties(xcCourseTables, xcCourseTablesDto);
        xcCourseTablesDto.setLearnStatus("70200");

        return xcCourseTablesDto;
    }
}
```

## service完善

```java
@Override
@Transactional
public XcChooseCourseDto addChooseCourse(String userId, Long courseId) {

    // 选课调用内容管理查询课程的收费规则
    CoursePublish coursepublish = contentServiceClient.getCoursepublish(courseId);

    if (coursepublish == null) {
        BusinessException.cast("课程不存在");
    }
    // 选课记录
    XcChooseCourse xcChooseCourse = null;
    // 收费规则
    String charge = coursepublish.getCharge();
    if ("201000".equals(charge)) { // 课程免费
        // 如果课程免费，向选课记录表、我的课程表写数据
        xcChooseCourse = addFreeCourse(userId, coursepublish); // 选课记录表
        XcCourseTables xcCourseTables = addCourseTables(xcChooseCourse); //我的课程表
    } else {
        // 如果课程收费，向选课记录表写数据
        xcChooseCourse = addChargeCourse(userId, coursepublish); // 选课记录表
    }

    // 判断学生的学习资格
    XcCourseTablesDto xcCourseTablesDto = getLearningStatus(userId, courseId);

    // 构造返回值
    XcChooseCourseDto xcChooseCourseDto = new XcChooseCourseDto();
    // 拷贝属性
    BeanUtils.copyProperties(xcChooseCourse, xcChooseCourseDto);
    // 设置学习资格状态
    xcChooseCourseDto.setLearnStatus(xcCourseTablesDto.getLearnStatus());

    return xcChooseCourseDto;
}
```

## controller完善

```java
@ApiOperation("添加选课")
@PostMapping("/choosecourse/{courseId}")
public XcChooseCourseDto addChooseCourse(@PathVariable("courseId") Long courseId) {

    // 当前登录用户
    SecurityUtil.XcUser user = SecurityUtil.getUser();
    if (user == null) {
        BusinessException.cast("请先登录");
    }
    // 用户id
    String userId = user.getId();
    // 添加选课
    return myCourseTablesService.addChooseCourse(userId, courseId);

}
```

# 接口测试

## 单元测试

1、准备测试环境

发布两门课程，一门为免费，一门为收费。

小技巧：可以更改课程发布表已有课程的收费标准进行测试。

2、测试添加免费课程

成功：选课记录表一条记录、我的课程表一条记录。

3、测试添加收费课程

成功：选课记录表一条记录

4、重复添加选课

重复添加相同的课程，观察是否存在异常。

5、生成令牌，为方便生成令牌暂时将PasswordAuthServiceImpl类中的验证码屏蔽

## 前后端联调

> 课程发布流程

1. 登录门户网站，进入我的几机构，新增课程信息
2. 开启XXL-JOB课程发布的定时任务
3. 点击提交审核
4. 数据库`course_publish_pre`查看记录，将该记录的`status`改为202004，相当于审核通过，在`course_base`找到该课程记录，将其`auit_status`改为202004
5. 回到课程首页，点击发布

> 测试流程：

1、启动认证服务、网关服务、验证码服务、学习中心服务、内容管理服务。

2、发布一门免费课程、一门收费课程

3、进入课程详情界面，点击“马上学习”

4、报名成功，自动跳转到学习界面。

5、观察选课记录表、我的课程表数据是否正确。