# 1 需求分析

下边根据内容管理模块的业务流程，下一步要实现新增课程，在新增课程界面，有三处信息需要选择，如下图：

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-28.png)

课程等级、课程类型来源于数据字典表，此部分的信息前端已从系统管理服务读取。

课程分类信息没有在数据字典表中存储，而是由单独一张课程分类表，存储在内容管理数据库中。

> course_category课程分类表的结构

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-29.png)

这张表是一个树型结构，通过父结点id将各元素组成一个树。

可以看下该表的数据，下图是一部分数据：

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-30.png)

现在的需求是需要**在内容管理服务中编写一个接口读取该课程分类表的数据，组成一个树型结构返回给前端**。

# 2 接口定义

点击新增课程，观察前端的请求记录：

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-31.png)

http://localhost:8601/api/content/course-category/tree-nodes 该地址正是前端获取课程分类的接口地址。

## 返回数据格式

> 此接口要返回全部课程分类，以树型结构返回 

```json
 [
         {
            "childrenTreeNodes" : [
               {
                  "childrenTreeNodes" : null,
                  "id" : "1-1-1",
                  "isLeaf" : null,
                  "isShow" : null,
                  "label" : "HTML/CSS",
                  "name" : "HTML/CSS",
                  "orderby" : 1,
                  "parentid" : "1-1"
               },
               {
                  "childrenTreeNodes" : null,
                  "id" : "1-1-2",
                  "isLeaf" : null,
                  "isShow" : null,
                  "label" : "JavaScript",
                  "name" : "JavaScript",
                  "orderby" : 2,
                  "parentid" : "1-1"
               },
               {
                  "childrenTreeNodes" : null,
                  "id" : "1-1-3",
                  "isLeaf" : null,
                  "isShow" : null,
                  "label" : "jQuery",
                  "name" : "jQuery",
                  "orderby" : 3,
                  "parentid" : "1-1"
               },
               {
                  "childrenTreeNodes" : null,
                  "id" : "1-1-4",
                  "isLeaf" : null,
                  "isShow" : null,
                  "label" : "ExtJS",
                  "name" : "ExtJS",
                  "orderby" : 4,
                  "parentid" : "1-1"
               },
               {
                  "childrenTreeNodes" : null,
                  "id" : "1-1-5",
                  "isLeaf" : null,
                  "isShow" : null,
                  "label" : "AngularJS",
                  "name" : "AngularJS",
                  "orderby" : 5,
                  "parentid" : "1-1"
               },
               {
                  "childrenTreeNodes" : null,
                  "id" : "1-1-6",
                  "isLeaf" : null,
                  "isShow" : null,
                  "label" : "ReactJS",
                  "name" : "ReactJS",
                  "orderby" : 6,
                  "parentid" : "1-1"
               },
               {
                  "childrenTreeNodes" : null,
                  "id" : "1-1-7",
                  "isLeaf" : null,
                  "isShow" : null,
                  "label" : "Bootstrap",
                  "name" : "Bootstrap",
                  "orderby" : 7,
                  "parentid" : "1-1"
               },
               {
                  "childrenTreeNodes" : null,
                  "id" : "1-1-8",
                  "isLeaf" : null,
                  "isShow" : null,
                  "label" : "Node.js",
                  "name" : "Node.js",
                  "orderby" : 8,
                  "parentid" : "1-1"
               },
               {
                  "childrenTreeNodes" : null,
                  "id" : "1-1-9",
                  "isLeaf" : null,
                  "isShow" : null,
                  "label" : "Vue",
                  "name" : "Vue",
                  "orderby" : 9,
                  "parentid" : "1-1"
               },
               {
                  "childrenTreeNodes" : null,
                  "id" : "1-1-10",
                  "isLeaf" : null,
                  "isShow" : null,
                  "label" : "其它",
                  "name" : "其它",
                  "orderby" : 10,
                  "parentid" : "1-1"
               }
            ],
            "id" : "1-1",
            "isLeaf" : null,
            "isShow" : null,
            "label" : "前端开发",
            "name" : "前端开发",
            "orderby" : 1,
            "parentid" : "1"
         },
         {
            "childrenTreeNodes" : [
               {
                  "childrenTreeNodes" : null,
                  "id" : "1-2-1",
                  "isLeaf" : null,
                  "isShow" : null,
                  "label" : "微信开发",
                  "name" : "微信开发",
                  "orderby" : 1,
                  "parentid" : "1-2"
               },
               {
                  "childrenTreeNodes" : null,
                  "id" : "1-2-2",
                  "isLeaf" : null,
                  "isShow" : null,
                  "label" : "iOS",
                  "name" : "iOS",
                  "orderby" : 2,
                  "parentid" : "1-2"
               },
               {
                  "childrenTreeNodes" : null,
                  "id" : "1-2-3",
                  "isLeaf" : null,
                  "isShow" : null,
                  "label" : "手游开发",
                  "name" : "手游开发",
                  "orderby" : 3,
                  "parentid" : "1-2"
               },
               {
                  "childrenTreeNodes" : null,
                  "id" : "1-2-4",
                  "isLeaf" : null,
                  "isShow" : null,
                  "label" : "Swift",
                  "name" : "Swift",
                  "orderby" : 4,
                  "parentid" : "1-2"
               },
               {
                  "childrenTreeNodes" : null,
                  "id" : "1-2-5",
                  "isLeaf" : null,
                  "isShow" : null,
                  "label" : "Android",
                  "name" : "Android",
                  "orderby" : 5,
                  "parentid" : "1-2"
               },
               {
                  "childrenTreeNodes" : null,
                  "id" : "1-2-6",
                  "isLeaf" : null,
                  "isShow" : null,
                  "label" : "ReactNative",
                  "name" : "ReactNative",
                  "orderby" : 6,
                  "parentid" : "1-2"
               },
               {
                  "childrenTreeNodes" : null,
                  "id" : "1-2-7",
                  "isLeaf" : null,
                  "isShow" : null,
                  "label" : "Cordova",
                  "name" : "Cordova",
                  "orderby" : 7,
                  "parentid" : "1-2"
               },
               {
                  "childrenTreeNodes" : null,
                  "id" : "1-2-8",
                  "isLeaf" : null,
                  "isShow" : null,
                  "label" : "其它",
                  "name" : "其它",
                  "orderby" : 8,
                  "parentid" : "1-2"
               }
            ],
            "id" : "1-2",
            "isLeaf" : null,
            "isShow" : null,
            "label" : "移动开发",
            "name" : "移动开发",
            "orderby" : 2,
            "parentid" : "1"
         }
   ]
```

上边的数据格式是一个数组结构，数组的元素即为分类信息，分类信息设计两级分类

第一级的分类信息示例如下：

```json
"id" : "1-2",
"isLeaf" : null,
"isShow" : null,
"label" : "移动开发",
"name" : "移动开发",
"orderby" : 2,
"parentid" : "1"
```

第二级的分类是第一级分类中childrenTreeNodes属性，它是一个数组结构：

```json
{
    "id" : "1-2",
    "isLeaf" : null,
    "isShow" : null,
    "label" : "移动开发",
    "name" : "移动开发",
    "orderby" : 2,
    "parentid" : "1",
    "childrenTreeNodes" : [
                   {
                      "childrenTreeNodes" : null,
                      "id" : "1-2-1",
                      "isLeaf" : null,
                      "isShow" : null,
                      "label" : "微信开发",
                      "name" : "微信开发",
                      "orderby" : 1,
                      "parentid" : "1-2"
                   }
 }
```

## 分类信息DTO类

```java
@Data
public class CourseCategoryTreeDto extends CourseCategory implements Serializable {

    List childrenTreeNodes;
}
```

## 接口定义

```java
@Slf4j
@RestController
@RequestMapping("/course-category")
@Api(value = "课程分类接口", tags = "课程分类接口")
public class CourseCategoryController {

    @ApiOperation("课程分类查询接口")
    @GetMapping("/tree-nodes")
    public List<CourseCategoryTreeDto> queryTreeNodes() {
        return null;
    }
}
```

# 3 接口开发

## DAO开发

> 递归查询树型结构数据

```sql
WITH [RECURSIVE]
	cte_name[(col_name [, col_name] ...)] AS (subquery)
	[,cte_name [(col_name [, col_name] ...)] AS (subquery)]
```

```sql
-- mysql version 8.0
WITH RECURSIVE t1 AS (
	SELECT p.* FROM course_category p WHERE p.id='1'
	UNION ALL
	SELECT p1.* FROM course_category p1 INNER JOIN t1 ON t1.id=p1.parentid
)
SELECT * FROM t1
```

> 自连接查询树型结构数据

**二级分类**

```sql
 select
        one.id            one_id,
        one.name          one_name,
        one.parentid      one_parentid,
        one.orderby       one_orderby,
        one.label         one_label,
        two.id            two_id,
        two.name          two_name,
        two.parentid      two_parentid,
        two.orderby       two_orderby,
        two.label         two_label
    from course_category one
             inner join course_category two on one.id = two.parentid
    where one.parentid = 1
      and one.is_show = 1
      and two.is_show = 1
    order by one.orderby,
             two.orderby
```

> mapper

```java
public interface CourseCategoryMapper extends BaseMapper<CourseCategory> {

    List<CourseCategoryTreeDto> selectTreeNodes();
}
```

> xml

```xml
<select id="selectTreeNodes" parameterType="string" resultType="com.cyan.springcloud.model.dto.CourseCategoryTreeDto">
    WITH RECURSIVE t1 AS (
      SELECT * FROM course_category WHERE id = #{id}
      UNION ALL
      SELECT t2.* FROM course_category t2 INNER JOIN t1 ON t1.id = t2.parentid
    )
    SELECT * FROM t1
    ORDER BY t1.id
</select>
```

## Service开发

```java
public interface CourseCategoryService {

    /**
     * 课程分类树形结构查询
     *
     * @param id
     * @return
     */
    List<CourseCategoryTreeDto> queryTreeNodes(String id);
}

```

```java
@Service
public class CourseCategoryServiceImpl implements CourseCategoryService {

    @Resource
    private CourseCategoryMapper courseCategoryMapper;

    @Override
    public List<CourseCategoryTreeDto> queryTreeNodes(String id) {
        // 调用mapper递归查询分类信息
        List<CourseCategoryTreeDto> courseCategoryTreeDtos = courseCategoryMapper.selectTreeNodes(id);

        // 找到每个节点的子节点，最终封装成List<CourseCategoryTreeDto>
        // 将List转Map，key：节点id，value：CourseCategoryTreeDto对象
        Map<String, CourseCategoryTreeDto> treeDtoMap = courseCategoryTreeDtos
                .stream()
                .filter(item->!id.equals(item.getId()))
                .collect(Collectors.toMap(key -> key.getId(), value -> value, (key1, key2) -> key2));
        // 定义返回对象
        List<CourseCategoryTreeDto> list = new ArrayList<>();
        // 遍历courseCategoryTreeDtos，将其中子节点放入父节点的childrenTreeNodes
        courseCategoryTreeDtos.stream().filter(item->!id.equals(item.getId())).forEach(item->{
            if (item.getParentid().equals(id)) { // 存入二级节点
                list.add(item);
            }
            // 处理三级节点
            // 找到节点的父亲节点
            CourseCategoryTreeDto parentNode = treeDtoMap.get(item.getParentid());
            if (parentNode != null) {
                if (parentNode.getChildrenTreeNodes() == null) {
                    parentNode.setChildrenTreeNodes(new ArrayList<CourseCategoryTreeDto>());
                }
                parentNode.getChildrenTreeNodes().add(item);
            }

        });

        return list;
    }
}
```

## Controller开发

```java
@Slf4j
@RestController
@RequestMapping("/course-category")
@Api(value = "课程分类接口", tags = "课程分类接口")
public class CourseCategoryController {

    @Resource
    private CourseCategoryService courseCategoryService;

    @ApiOperation("课程分类查询接口")
    @GetMapping("/tree-nodes")
    public List<CourseCategoryTreeDto> queryTreeNodes() {
        return courseCategoryService.queryTreeNodes("1");
    }
}
```

