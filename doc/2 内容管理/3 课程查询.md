# 1 需求分析

## 业务流程

**1.教学机构人员点击课程管理首先进入课程查询界面，如下： **

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-17.png)

**2.在课程进行列表查询页面输入查询条件查询课程信息**

* 当不输入查询条件时输入全部课程信息 

* 输入查询条件查询符合条件的课程信息

* 约束：本教学机构查询本机构的课程信息 

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-18.png)

## 数据模型

课程查询功能涉及的数据表有课程基本信息表、课程计划表，如下图： 

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-19.png)

> 查询条件

| 查询条件     | 说明                                 |
| ------------ | ------------------------------------ |
| 课程名称     | 可以模糊搜索                         |
| 课程审核状态 | 未提交、已提交、审核通过、审核未通过 |
| 课程发布状态 | 未发布、已发布、已下线               |

**因为是分页查询所以查询条件中还要包括当前页码、每页显示记录数**

> 查询结果

| 查询结果 |
| :------: |
|  课程id  |
| 课程名称 |
|  任务数  |
| 创建时间 |
| 审核状态 |
|   类型   |

* **基本来源于课 基本信息表**
* **任务数需要关联教学计划学查询**
* **因为是分页查询所以查询结果中还要包括总记录数、当前页、每页显示记录数** 

## 实体模型

PO即持久对象(Persistent Object)，它们是由一组属性和属性的get和set方法组成，PO对应于数据库的表。  

 在开发持久层代码时需要根据数据表编写PO类，在实际开发中通常使用代码生成器（工具）生成PO类 的代码 

[使用mybatis-plus的generator工程生成PO类](https://github.com/baomidou/generator) 

# 2 接口定义

## 接口定义分析

>  定义一个接口需要包括以下几个方面： 

**1.协议** 

* 通常协议采用HTTP，查询类接口通常为get或post，查询条件较少的使用get，较多的使用post 
* 本接口使用 http post
* 确定content-type，参数以什么数据格式提交，结果以什么数据格式响应。 一般情况没有特殊情况结果以json 格式响应。 

**2.分析请求参数**

* 根据前边对数据模型的分析，请求参数为：**课程名称、课程审核状态、当前页码、每页显示记录数**
* <font color="red">**根据分析的请求参数定义模型类** </font>

**3. 分析响应结果 **

* 根据前边对数据模型的分析，响应结果为数据列表加一些分页信息（总记录数、当前页、每页显示记录 数）  

* 数据列表中数据的属性包括：课程id、课程名称、任务数、创建时间、审核状态、类型   

* 注意：查询结果中的审核状态为数据字典中的代码字段，前端会根据审核状态代码找到对应的名称显示 

* <font color="red">**根据分析的响应结果定义模型类**</font> 

**4.分析完成，使用SpringBoot注解开发一个Http接口**

**5.使用接口文档工具查看接口的内容**

**6.接口中调用Service方法完成业务处理 **

> 接口请求示例
>
> ```txt
> POST /content/course/list?pageNo=2&pageSize=1
> Content-Type: application/json
> {
>     "auditStatus": "202002",
>     "courseName": ""
> }
> ###成功响应结果
> {
>     "items": [
>     `{
>         "id": 26,
>         "companyId": 1232141425,
>         "companyName": null,
>         "name": "spring cloud实战",
>         "users": "所有人",
>         "tags": null,
>         "mt": "1-3",
>         "mtName": null,
>         "st": "1-3-2",
>         "stName": null,
>         "grade": "200003",
>         "teachmode": "201001",
>         "description": "本课程主要从四个章节进行讲解： 1.微服务架构入门 2.spring cloud 基
>         础入门 3.实战Spring Boot 4.注册中心eureka。",
>         "pic": "https://cdn.educba.com/academy/wp-content/uploads/2018/08/SpringBOOT-Interview-questions.jpg",
>         "createDate": "2019-09-04 09:56:19",
>         "changeDate": "2021-12-26 22:10:38",
>         "createPeople": null,
>         "changePeople": null,
>         "auditStatus": "202002",
>         "auditMind": null,
>         "auditNums": 0,
>         "auditDate": null,
>         "auditPeople": null,
>         "status": 1,
>         "coursePubId": null,
>         "coursePubDate": null
>     	}
>     ],
>     "counts": 23,
>     "page": 2,
>     "pageSize": 1
> }
> ```

## 课程查询接口定义

### 定义请求模型类

对于**查询条件较多的接口定义单独的模型类接收参数**，由于分页查询这一类的接口在项目较多，这里针对分页查询的参数（当前页码、每页显示记录数）单独在基础工程中定义。 

```java
@Data
@ToString
public class PageParams {
    // 当前页码默认值
    public static final long DEFAULT_PAGE_CURRENT = 1L;
    // 每页记录数默认值
    public static final long DEFAULT_PAGE_SIZE = 10L;
    // 当前页码
    private Long pageNo = DEFAULT_PAGE_CURRENT;
    // 每页记录数默认值
    private Long pageSize = DEFAULT_PAGE_SIZE;
    
    public PageParams(){
    }

    public PageParams(long pageNo,long pageSize){
        this.pageNo = pageNo;
        this.pageSize = pageSize;
    }
}
```

除了分页查询参数，剩下的就是课程查询的特有参数，此时需要在内容管理的model工程中**定义课程查询参数模型类**。 定义DTO包，DTO即**数据传输对象**（DTO）(Data Transfer Object)，**用于接口层和业务层之间传输数据**。  

```java
@Data
@ToString
public class QueryCourseParamsDto {

    // 审核状态
    private String auditStatus;
    // 课程名称
    private String courseName;
    // 发布状态
    private String publishStatus;
}
```

### 多样化的模型类

| 模型类          | 说明                                    |
| --------------- | --------------------------------------- |
| DTO数据传输对象 | DTO用于**接口层向业务层**之间传输数据   |
| PO持久化对象    | PO用于**业务层与持久层**之间传输数据    |
| VO视图对象      | VO对象用在**前端与接口层**之间 传输数据 |

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-20.png)

> VO适用情况
>
> 当前端有多个平台且接口存在差异时就需要设置VO对象用于前端和接口层传输数据。 

课程列表查询接口，根据用户需求用户在手机端也要查询课程信息，此时课程查询接口是否需要编写手机端和PC端两个接口呢 

如果用户要求通过手机和PC的查询条件或查询结果不一样，此时就需要定义两个Controller课程查询接 口，每个接口定义VO对象与前端传输数据 

* 手机查询：根据课程状态查询，查询结果只有课程名称和课程状态
* PC查询：可以根据课程名称、课程状态、课程审核状态等条件查询，查询结果也比手机查询结果内容 多。  

**Service业务层尽量提供一个业务接口，即使两个前端接口需要的数据不一样，Service可以提供 一个最全查询结果，由Controller进行数据整合。** 

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-21.png)

**如果前端的接口没有多样性且比较固定，此时可以取消VO，只用DTO即可** 

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-22.png)

### 定义相应模型类

针对分页查询结果经过分析也存在固定的数据和格式，所以在base工程定义一个基础的模型类。 

### 定义接口

根据分析，此接口提供 HTTP post协议，查询条件以json格式提交，响应结果为json 格式 

> 在api工程导入依赖

```xml
<dependencies>
        
        <dependency>
            <groupId>com.cyan.springcloud</groupId>
            <artifactId>online-education-content-model</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <dependency>
            <groupId>com.cyan.springcloud</groupId>
            <artifactId>online-education-content-service</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-context</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <!-- 排除 Spring Boot 依赖的日志包冲突 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter</artifactId>
            <exclusions>
                <exclusion>
                    <groupId>org.springframework.boot</groupId>
                    <artifactId>spring-boot-starter-logging</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-log4j2</artifactId>
        </dependency>
        <dependency>
            <groupId>com.spring4all</groupId>
            <artifactId>swagger-spring-boot-starter</artifactId>
            <version>1.9.0.RELEASE</version>
        </dependency>

    </dependencies>
```

> controller
>
>  **说明：pageParams分页参数通过url的key/value传入，queryCourseParams通过json数据传入，使用 @RequestBody注解将json转成QueryCourseParamsDto对象。**  

```java
@RestController
@RequestMapping("/course")
@Api(value = "课程信息编辑接口", tags = "课程信息编辑接口")
public class CourseBaseInfoController {

    /**
     * 课程查询接口
     *
     * @param pageParams 分页参数
     * @param queryCourseParamsDto 请求参数
     * @return
     */
    @ApiOperation("课程查询接口")
    @PostMapping("/list")
    public PageResult<CourseBase> list(PageParams pageParams, @RequestBody QueryCourseParamsDto queryCourseParamsDto) {
        return null;
    }
}
```

> 主启动

```java
@EnableSwagger2Doc
@SpringBootApplication
public class ContentApiApplication {
    public static void main(String[] args) {
        SpringApplication.run(ContentApiApplication.class, args);
    }
}
```

> bootstrap.yml

```yml
spring:
  application:
    name: online-education-content-api

logging:
  config: classpath:log4j2-dev.xml

server:
  servlet:
    context-path: /content
  port: 63040


swagger:
  title: "在线教育网站"
  description: "内容系统管理系统对课程相关信息进行业务管理数据"
  # base-package为扫描的包路径，扫描Controller类。
  base-package: com.cyan.springcloud.content
  enabled: true
  version: 1.0.0
```

> 测试

 http://localhost:63040/content/swagger-ui.html 

### Swagger介绍 

> OpenAPI规范

OpenAPI规范（OpenAPI Specification 简称OAS）是Linux基金会的一个项目，试图通过定义一种用 来描述API格式或API定义的语言，来规范RESTful服务开发过程 

> Swagger

Swagger是全球最大的OpenAPI规范（OAS）API开发工具框架，Swagger是一个在线接口文档的生 成工具，前后端开发人员依据接口文档进行开发。 (https://swagger.io/)  

```xml
<dependency>
    <groupId>com.spring4all</groupId>
    <artifactId>swagger-spring-boot-starter</artifactId>
</dependency>
```

> 在Java类中添加Swagger的注解即可生成Swagger接口，常用Swagger注解如下： 

| 注解               | 说明                                 |
| ------------------ | ------------------------------------ |
| @Api               | 修饰整个类，描述Controller的作用     |
| @ApiOperation      | 描述一个类的一个方法，或者说一个接口 |
| @ApiParam          | 单个参数描述                         |
| @ApiModel          | 用对象来接收参数                     |
| @ApiModelProperty  | 用对象接收参数时，描述对象的一个字段 |
| @ApiResponse       | HTTP响应其中1个描述                  |
| @ApiResponses      | HTTP响应整体描述                     |
| @ApiIgnore         | 使用该注解忽略这个API                |
| @ApiError          | 发生错误返回的信息                   |
| @ApiImplicitParam  | 一个请求参数                         |
| @ApiImplicitParams | 多个请求参数                         |

>  @ApiImplicitParam属性： 

| 属性         | 取值   | 作用                                          |
| ------------ | ------ | --------------------------------------------- |
| paramType    |        | 查询参数类型                                  |
|              | path   | 以地址的形式提交数据                          |
|              | query  | 直接跟参数完成自动映射赋值                    |
|              | body   | 以流的形式提交 仅支持POST                     |
|              | header | 参数在request headers 里边提交                |
|              | form   | 以form表单的形式提交 仅支持POST               |
| dataType     |        | 参数的数据类型 只作为标志说明，并没有实际验证 |
|              | Long   |                                               |
|              | String |                                               |
| name         |        | 接收参数名                                    |
| value        |        | 接收参数的意义描述                            |
| required     |        | 参数是否必填                                  |
|              | true   | 必填                                          |
|              | false  | 非必填                                        |
| defaultValue |        | 默认值                                        |

> 使用Swagger可以进行接口的测试 

 修改接口内容，添加一些测试代码 

# 3 业务层开发

### DAO开发

> 项目依赖

```xml
 <dependencies>
        <dependency>
            <groupId>com.cyan.springcloud</groupId>
            <artifactId>online-education-content-model</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter</artifactId>
            <exclusions>
                <exclusion>
                    <groupId>org.springframework.boot</groupId>
                    <artifactId>spring-boot-starter-logging</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-log4j2</artifactId>
        </dependency>
    </dependencies>
```

> 配置扫描mapper及分页插件 

```java
@Configuration
@MapperScan("com.cyan.springcloud.mapper")
public class MybatisPlusConfig {

    // 定义分页拦截器
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}
```

> yml

```yml
spring:
  application:
    name: online-education-content-service
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/online_education_content?userUnicode=true&useSSL=false
    username: root
    password: root

logging:
  config: classpath:log4j2-dev.xml
```

> 测试类

```java
@SpringBootTest
public class CourseBaseMapperTest {

    @Resource
    private CourseBaseMapper courseBaseMapper;

    @Test
    void testCourseBaseMapper() {
        CourseBase courseBase = courseBaseMapper.selectById(71L);
        Assertions.assertNotNull(courseBase);
    }

}
```

