# 需求分析

 为学生提供注册入口，通过此入口注册的用户为学生用户  

界面访问地址：http://www.51xuecheng.cn/register.html

![](https://cyan-images.oss-cn-shanghai.aliyuncs.com/images/online-education-20230122-180.png)

> 接口

```json
手机验证码：/api/checkcode/phone?param1=手机号
注册：/api/auth/register
```

> 请求

```json
{
   cellphone:'',
   username:'',
   email:'',
   nickname:'',
   password:'',
   confirmpwd:'',
   checkcodekey:'',
   checkcode:''
}
```

> 响应

```json
200: 注册成功
其它：注册失败，失败原因使用统一异常处理返回的信息格式
```

> 执行流程：

1、校验验证码，如果不一致则抛出异常

2、校验两次密码是否一致，如果不一致则抛出异常

3、校验用户是否存在，如果存在则抛出异常

4、向用户表、用户角色关系表添加数据。角色为学生角色。

# 接口开发

```java
@ApiOperation(value = "注册", tags = "注册")
@PostMapping("/register")
public void register(@RequestBody RegisterDto registerDto) {
    
}
```

# 接口实现

> DTO类：接收注册请求参数

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
public class RegisterDto {
    
    private String cellphone;

    private String checkcode;

    private String checkcodekey;

    private String confirmpwd;

    private String email;

    private String nickname;

    private String password;

    private String username;
}
```

> Service

```java
/***
 * 注册
 * 
 * @param registerDto
 */
void register(RegisterDto registerDto);
```

```java
@Override
@Transactional
public void register(RegisterDto registerDto) {
    String uuid = UUID.randomUUID().toString();
    String email = registerDto.getEmail();
    String checkcode = registerDto.getCheckcode();
    Boolean verifyCheckCode = verifyCheckCode(email, checkcode);
    if (!verifyCheckCode) {
        throw new RuntimeException("验证码输入错误");
    }
    String password = registerDto.getPassword();
    String confirmpwd = registerDto.getConfirmpwd();
    if (!password.equals(confirmpwd)) {
        throw new RuntimeException("两次输入密码不一致");
    }
    LambdaQueryWrapper<XcUser> queryWrapper = new LambdaQueryWrapper<>();

    queryWrapper.eq(XcUser::getEmail, registerDto.getEmail());
    XcUser user = xcUserMapper.selectOne(queryWrapper);

    if (user != null) {
        throw new RuntimeException("用户已经存在，一个邮箱只能注册一个账户");
    }
    XcUser xcUser = new XcUser();
    BeanUtils.copyProperties(registerDto, xcUser);
    xcUser.setPassword(new BCryptPasswordEncoder().encode(password));
    xcUser.setId(uuid);
    xcUser.setUtype("101001");  // 学生类型
    xcUser.setStatus("1");
    xcUser.setName(registerDto.getNickname());
    xcUser.setCreateTime(LocalDateTime.now());
    int xcUserInsert = xcUserMapper.insert(xcUser);
    if (xcUserInsert <= 0) {
        throw new RuntimeException("新增用户信息失败");
    }
    XcUserRole xcUserRole = new XcUserRole();
    xcUserRole.setId(uuid);
    xcUserRole.setUserId(uuid);
    xcUserRole.setRoleId("17");
    xcUserRole.setCreateTime(LocalDateTime.now());
    int xcUserRoleInsert = xcUserRoleMapper.insert(xcUserRole);
    if (xcUserRoleInsert <= 0) {
        throw new RuntimeException("新增用户角色信息失败");
    }

}
```

> 完善接口

```java
@ApiOperation(value = "注册", tags = "注册")
@PostMapping("/register")
public void register(@RequestBody RegisterDto registerDto) {
    verifyService.register(registerDto);
}
```

